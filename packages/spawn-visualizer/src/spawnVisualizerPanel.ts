import * as vscode from 'vscode';
import * as path from 'path';
import * as fs from 'fs';
import { discoverPlanets, loadPlanetData, ProgressCallback } from './spawnDataLoader';
import { PlanetData, PlanetDataJSON, SpawnGroup, LairTemplate, ScreenplaySpawnGroup } from './types';
import { loadScreenplayIndex, rebuildScreenplayIndex, queryPlanetScreenplays } from './staticSpawnParser';
import type { ScreenplayIndexData, ScreenplayCacheEntry } from './staticSpawnParser';
import { parseWorldSnapshot, cellPositionsToJSON } from '@swgemu/core';

export class SpawnVisualizerPanel {
    public static currentPanel: SpawnVisualizerPanel | undefined;
    private readonly panel: vscode.WebviewPanel;
    private readonly scriptsPath: string;
    private readonly context: vscode.ExtensionContext;
    private disposables: vscode.Disposable[] = [];
    private screenplayIndex: ScreenplayIndexData | null = null;

    private constructor(panel: vscode.WebviewPanel, scriptsPath: string, context: vscode.ExtensionContext) {
        this.panel = panel;
        this.scriptsPath = scriptsPath;
        this.context = context;

        this.panel.onDidDispose(() => this.dispose(), null, this.disposables);
        this.panel.webview.onDidReceiveMessage(msg => {
            this.handleMessage(msg).catch(err => {
                console.error('Spawn Visualizer: unhandled message error:', err);
                this.panel.webview.postMessage({ type: 'error', message: String(err) });
            });
        }, null, this.disposables);
    }

    public static async createOrShow(context: vscode.ExtensionContext) {
        const workspaceRoot = vscode.workspace.workspaceFolders?.[0]?.uri.fsPath || '';
        const config = vscode.workspace.getConfiguration('swgForge');
        const scriptsPath = path.join(workspaceRoot, config.get<string>('serverScriptsPath', 'infinity_wicked/MMOCoreORB/bin/scripts'));

        if (SpawnVisualizerPanel.currentPanel) {
            SpawnVisualizerPanel.currentPanel.panel.reveal(vscode.ViewColumn.One);
            return;
        }

        const panel = vscode.window.createWebviewPanel(
            'spawnVisualizer',
            'Spawn Visualizer',
            vscode.ViewColumn.One,
            { enableScripts: true, retainContextWhenHidden: true }
        );

        SpawnVisualizerPanel.currentPanel = new SpawnVisualizerPanel(panel, scriptsPath, context);

        // Discover planets and send initial HTML
        let planets: string[] = [];
        try {
            planets = await discoverPlanets(scriptsPath);
        } catch (err: any) {
            console.error('Spawn Visualizer: Failed to discover planets:', err);
        }
        if (planets.length === 0) {
            console.warn('Spawn Visualizer: No planets found at', scriptsPath);
        }
        panel.webview.html = getWebviewHtml(planets);
    }

    private getCacheKey(planet: string): string { return 'spawn-cache-' + planet; }

    private async handleMessage(msg: any) {
        switch (msg.type) {
            case 'loadPlanet': {
                const planet = msg.planet as string;
                try {
                    // Check cache first
                    const cacheKey = this.getCacheKey(planet);
                    const cached = this.context.globalState.get<{ data: PlanetDataJSON; cellMap?: { [cellId: string]: { x: number; y: number; template: string } }; timestamp: number }>(cacheKey);
                    if (cached) {
                        this.panel.webview.postMessage({ type: 'loading', planet });
                        this.panel.webview.postMessage({ type: 'regions', regions: cached.data.regions, planetName: planet });
                        this.panel.webview.postMessage({ type: 'planetData', data: cached.data, cellMap: cached.cellMap || {}, cached: true, cachedAt: cached.timestamp });
                        break;
                    }
                    // No cache — full load
                    await this.loadAndCache(planet);
                } catch (err: any) {
                    this.panel.webview.postMessage({ type: 'error', message: err.message || String(err) });
                }
                break;
            }
            case 'rebuildPlanet': {
                const planet = msg.planet as string;
                try {
                    await this.context.globalState.update(this.getCacheKey(planet), undefined);
                    // Also rebuild the screenplay index from scratch
                    await this.rebuildScreenplayIndex();
                    await this.loadAndCache(planet);
                } catch (err: any) {
                    this.panel.webview.postMessage({ type: 'error', message: err.message || String(err) });
                }
                break;
            }
            case 'openFile': {
                const filePath = msg.path as string;
                const line = (msg.line as number) || 0;
                try {
                    const doc = await vscode.workspace.openTextDocument(filePath);
                    const editor = await vscode.window.showTextDocument(doc, vscode.ViewColumn.Beside);
                    if (line > 0) {
                        const pos = new vscode.Position(line - 1, 0);
                        editor.selection = new vscode.Selection(pos, pos);
                        editor.revealRange(new vscode.Range(pos, pos), vscode.TextEditorRevealType.InCenter);
                    }
                } catch { /* file may not exist */ }
                break;
            }
        }
    }

    private async loadAndCache(planet: string) {
        this.panel.webview.postMessage({ type: 'loading', planet });
        const progress: ProgressCallback = (pmsg) => {
            this.panel.webview.postMessage(pmsg);
        };

        // Load planet dynamic spawn data
        const data = await loadPlanetData(this.scriptsPath, planet, progress);

        // Load/refresh screenplay index (cached with timestamps — fast on subsequent calls)
        progress({ type: 'status', text: 'Loading screenplay index...' });
        if (!this.screenplayIndex) {
            this.screenplayIndex = await loadScreenplayIndex(this.context, this.scriptsPath, (p) => {
                progress({ type: 'status', text: p.phase + ' (' + p.filesScanned + '/' + p.filesTotal + ')' });
            });
        }

        // Query screenplay index for this planet's static spawns
        const planetScreenplays = queryPlanetScreenplays(this.screenplayIndex, planet);
        data.staticSpawns = convertScreenplayEntries(planetScreenplays, planet);

        // Load world snapshot (.ws) for cell→building position mapping
        progress({ type: 'status', text: 'Loading world snapshot...' });
        const cellMap = this.loadCellPositions(planet);

        const json = planetDataToJSON(data);
        const timestamp = Date.now();
        await this.context.globalState.update(this.getCacheKey(planet), { data: json, cellMap, timestamp });
        this.panel.webview.postMessage({ type: 'planetData', data: json, cellMap: cellMap || {}, cached: false, cachedAt: timestamp });
    }

    /** Force rebuild the screenplay index from scratch */
    private async rebuildScreenplayIndex() {
        this.screenplayIndex = await rebuildScreenplayIndex(this.context, this.scriptsPath, (p) => {
            this.panel.webview.postMessage({ type: 'status', text: 'Rebuilding screenplay index: ' + p.phase });
        });
    }

    /**
     * Load the .ws world snapshot for a planet and return a cellId→position map.
     * Checks tre/infinity/snapshot/ then tre/vanilla/snapshot/ for the file.
     */
    private loadCellPositions(planet: string): { [cellId: string]: { x: number; y: number; template: string } } | undefined {
        const workspaceRoot = vscode.workspace.workspaceFolders?.[0]?.uri.fsPath;
        if (!workspaceRoot) return undefined;

        const config = vscode.workspace.getConfiguration('swgForge');
        const treDirs = [
            path.join(workspaceRoot, config.get<string>('tre.referencePath', 'tre/infinity')),
            path.join(workspaceRoot, config.get<string>('tre.vanillaPath', 'tre/vanilla')),
        ];

        for (const treDir of treDirs) {
            const wsPath = path.join(treDir, 'snapshot', planet + '.ws');
            if (fs.existsSync(wsPath)) {
                try {
                    const data = fs.readFileSync(wsPath);
                    const summary = parseWorldSnapshot(new Uint8Array(data));
                    console.log(`Spawn Visualizer: ${planet}.ws — ${summary.cellCount} cells mapped from ${summary.nodeCount} nodes`);
                    return cellPositionsToJSON(summary);
                } catch (err) {
                    console.error(`Spawn Visualizer: failed to parse ${wsPath}:`, err);
                }
            }
        }

        console.warn(`Spawn Visualizer: no .ws snapshot found for ${planet}`);
        return undefined;
    }

    private dispose() {
        SpawnVisualizerPanel.currentPanel = undefined;
        this.panel.dispose();
        for (const d of this.disposables) { d.dispose(); }
        this.disposables = [];
    }
}

/** Convert screenplay cache entries to the webview-friendly format */
function convertScreenplayEntries(entries: ScreenplayCacheEntry[], planet: string): ScreenplaySpawnGroup[] {
    return entries.map(e => {
        // Filter entries to only this planet's mobiles (screenplays can span planets)
        const spawns = e.entries
            .filter(c => c.kind === 'mobile' && c.planet === planet)
            .map(c => {
                const m = c as any;
                return { template: m.template, x: m.x, z: m.z, y: m.y, heading: m.heading, cellId: m.cellId, line: m.line };
            });
        const worldCount = spawns.filter(s => s.cellId === 0).length;
        const intCount = spawns.filter(s => s.cellId !== 0).length;
        return {
            name: e.index.name,
            sourceFile: e.index.filePath,
            category: e.index.category,
            spawns,
            worldSpawnCount: worldCount,
            interiorSpawnCount: intCount,
        };
    }).filter(g => g.spawns.length > 0);
}

function planetDataToJSON(data: PlanetData): PlanetDataJSON {
    const spawnGroups: { [k: string]: SpawnGroup } = {};
    for (const [k, v] of data.spawnGroups) { spawnGroups[k] = v; }
    const lairTemplates: { [k: string]: LairTemplate } = {};
    for (const [k, v] of data.lairTemplates) { lairTemplates[k] = v; }
    const creatures: { [k: string]: any } = {};
    for (const [k, v] of data.creatures) { creatures[k] = v; }
    return {
        planetName: data.planetName,
        regions: data.regions,
        spawnGroups,
        lairTemplates,
        creatures,
        missingCreatures: data.missingCreatures,
        warnings: data.warnings,
        staticSpawns: data.staticSpawns || [],
    };
}

// ── Webview HTML ────────────────────────────────────────────────────────────────

function getWebviewHtml(planets: string[]): string {
    const planetOptions = planets.map(function(p) {
        return '<option value="' + p + '">' + p.charAt(0).toUpperCase() + p.slice(1).replace(/_/g, ' ') + '</option>';
    }).join('\n');

    // Using array.join pattern for SSH remote compatibility (no template literals in document.write)
    var parts = [];
    parts.push('<!DOCTYPE html>');
    parts.push('<html lang="en"><head><meta charset="UTF-8">');
    parts.push('<meta name="viewport" content="width=device-width, initial-scale=1.0">');
    parts.push('<title>Spawn Visualizer</title>');
    parts.push('<style>');
    parts.push(getStyles());
    parts.push('</style></head><body>');

    // Header
    parts.push('<div class="header">');
    parts.push('  <span class="title">Spawn Visualizer</span>');
    parts.push('  <label>Planet: <select id="planetSelect"><option value="">-- Select --</option>');
    parts.push('  ' + planetOptions);
    parts.push('  </select></label>');
    parts.push('  <button id="rebuildBtn" class="rebuild-btn hidden" title="Clear cache and reload from Lua files">Rebuild</button>');
    parts.push('  <div class="tab-bar">');
    parts.push('    <button class="tab active" data-tab="map">Map</button>');
    parts.push('    <button class="tab" data-tab="world">World</button>');
    parts.push('    <button class="tab" data-tab="static">Static</button>');
    parts.push('    <button class="tab" data-tab="reports">Reports</button>');
    parts.push('  </div>');
    parts.push('  <span id="loadingIndicator" class="hidden">Loading...</span>');
    parts.push('  <span id="cacheIndicator" class="cache-indicator hidden"></span>');
    parts.push('  <span id="statsBar" class="stats-bar"></span>');
    parts.push('</div>');

    // Map tab content
    parts.push('<div class="tab-content active" id="tabMap">');
    parts.push('  <div class="main">');

    // Left panel — creature list with filters
    parts.push('    <div class="creature-panel" id="creaturePanel">');
    parts.push('      <div class="panel-header">Creatures</div>');
    parts.push('      <input type="text" id="creatureSearch" placeholder="Search creatures..." class="search-input">');
    parts.push('      <div class="filter-bar">');
    parts.push('        <label class="filter-toggle" title="Hide creatures with 0 spawn regions"><input type="checkbox" id="fSpawned" checked> Spawned</label>');
    parts.push('        <label class="filter-toggle" title="Tameable creatures (tamingChance > 0)"><input type="checkbox" id="fBabies"> Babies</label>');
    parts.push('        <label class="filter-toggle" title="NPCs only (mobType = NPC)"><input type="checkbox" id="fNpcs"> NPCs</label>');
    parts.push('      </div>');
    parts.push('      <div class="cl-slider">');
    parts.push('        <label>CL: <span id="clMinLabel">1</span> - <span id="clMaxLabel">300</span></label>');
    parts.push('        <div class="range-row">');
    parts.push('          <input type="range" id="clMin" min="1" max="300" value="1">');
    parts.push('          <input type="range" id="clMax" min="1" max="300" value="300">');
    parts.push('        </div>');
    parts.push('      </div>');
    parts.push('      <div id="creatureCount" class="creature-count"></div>');
    parts.push('      <div id="creatureList" class="creature-list"><div class="empty-msg">Select a planet</div></div>');
    parts.push('    </div>');

    // Center — canvas
    parts.push('    <div class="canvas-container">');
    parts.push('      <canvas id="mapCanvas"></canvas>');
    parts.push('      <div class="coords-overlay" id="coordsOverlay">0, 0</div>');
    parts.push('    </div>');

    // Right panel — region detail
    parts.push('    <div class="region-panel" id="regionPanel">');
    parts.push('      <div class="panel-header">');
    parts.push('        <span id="regionTitle">Region</span>');
    parts.push('        <button id="regionClose" class="panel-close" title="Close">&times;</button>');
    parts.push('      </div>');
    parts.push('      <div id="regionContent" class="region-content"></div>');
    parts.push('    </div>');

    parts.push('  </div>');
    parts.push('</div>');

    // World Spawns tab content
    parts.push('<div class="tab-content" id="tabWorld">');
    parts.push('  <div class="main">');

    // Left panel — world creature list with filters
    parts.push('    <div class="creature-panel" id="worldPanel">');
    parts.push('      <div class="panel-header">World Spawn Pool</div>');
    parts.push('      <input type="text" id="worldSearch" placeholder="Search creatures..." class="search-input">');
    parts.push('      <div class="filter-bar">');
    parts.push('        <label class="filter-toggle" title="Tameable creatures"><input type="checkbox" id="wfBabies"> Babies</label>');
    parts.push('        <label class="filter-toggle" title="NPCs only"><input type="checkbox" id="wfNpcs"> NPCs</label>');
    parts.push('      </div>');
    parts.push('      <div class="cl-slider">');
    parts.push('        <label>CL: <span id="wClMinLabel">1</span> - <span id="wClMaxLabel">300</span></label>');
    parts.push('        <div class="range-row">');
    parts.push('          <input type="range" id="wClMin" min="1" max="300" value="1">');
    parts.push('          <input type="range" id="wClMax" min="1" max="300" value="300">');
    parts.push('        </div>');
    parts.push('      </div>');
    parts.push('      <div id="worldCount" class="creature-count"></div>');
    parts.push('      <div id="worldList" class="creature-list"><div class="empty-msg">Select a planet</div></div>');
    parts.push('    </div>');

    // Center — world map canvas
    parts.push('    <div class="canvas-container" id="worldCanvasContainer">');
    parts.push('      <canvas id="worldCanvas"></canvas>');
    parts.push('      <div class="coords-overlay" id="worldCoordsOverlay">0, 0</div>');
    parts.push('    </div>');

    parts.push('  </div>');
    // Footer bar
    parts.push('  <div id="worldFooter" class="world-footer"></div>');
    parts.push('</div>');

    // Static Spawns tab content
    parts.push('<div class="tab-content" id="tabStatic">');
    parts.push('  <div class="main">');

    // Left panel — screenplay list
    parts.push('    <div class="creature-panel" id="staticPanel">');
    parts.push('      <div class="panel-header">Screenplays</div>');
    parts.push('      <input type="text" id="staticSearch" placeholder="Search spawns..." class="search-input">');
    parts.push('      <div class="filter-bar">');
    parts.push('        <label class="filter-toggle"><input type="checkbox" id="sfWorld" checked> World</label>');
    parts.push('        <label class="filter-toggle"><input type="checkbox" id="sfInterior" checked> Interior</label>');
    parts.push('      </div>');
    parts.push('      <div class="filter-bar">');
    parts.push('        <select id="sfCategory" style="font-size:11px;flex:1">');
    parts.push('          <option value="">All Categories</option>');
    parts.push('          <option value="cave">Caves</option>');
    parts.push('          <option value="poi">POIs</option>');
    parts.push('          <option value="city">Cities</option>');
    parts.push('          <option value="static">Static</option>');
    parts.push('          <option value="dungeon">Dungeons</option>');
    parts.push('          <option value="custom">Custom</option>');
    parts.push('        </select>');
    parts.push('      </div>');
    parts.push('      <div id="staticCount" class="creature-count"></div>');
    parts.push('      <div id="staticList" class="creature-list"><div class="empty-msg">Select a planet</div></div>');
    parts.push('    </div>');

    // Center — static map canvas (separate from dynamic map)
    parts.push('    <div class="canvas-container" id="staticCanvasContainer">');
    parts.push('      <canvas id="staticCanvas"></canvas>');
    parts.push('      <div class="coords-overlay" id="staticCoordsOverlay">0, 0</div>');
    parts.push('      <div class="zoom-hint" id="zoomHint">Scroll to zoom</div>');
    parts.push('    </div>');

    // Right panel — spawn detail
    parts.push('    <div class="region-panel" id="staticDetailPanel">');
    parts.push('      <div class="panel-header">');
    parts.push('        <span id="staticDetailTitle">Details</span>');
    parts.push('        <button id="staticDetailClose" class="panel-close" title="Close">&times;</button>');
    parts.push('      </div>');
    parts.push('      <div id="staticDetailContent" class="region-content"></div>');
    parts.push('    </div>');

    parts.push('  </div>');
    parts.push('</div>');

    // Reports tab content
    parts.push('<div class="tab-content" id="tabReports">');
    parts.push('  <div class="reports-container">');
    parts.push('    <div id="reportsContent"><div class="empty-msg">Select a planet to generate reports</div></div>');
    parts.push('  </div>');
    parts.push('</div>');

    parts.push('<script>');
    parts.push(getScript());
    parts.push('</script>');
    parts.push('</body></html>');
    return parts.join('\n');
}

function getStyles(): string {
    return [
        '* { margin: 0; padding: 0; box-sizing: border-box; }',
        'body { font-family: var(--vscode-font-family, "Segoe UI", sans-serif); font-size: 13px;',
        '  color: var(--vscode-foreground, #ccc); background: var(--vscode-editor-background, #1e1e1e);',
        '  display: flex; flex-direction: column; height: 100vh; overflow: hidden; }',

        // Header
        '.header { display: flex; align-items: center; gap: 12px; padding: 6px 12px;',
        '  background: var(--vscode-titleBar-activeBackground, #2d2d2d);',
        '  border-bottom: 1px solid var(--vscode-panel-border, #444); flex-shrink: 0; }',
        '.title { font-weight: 600; font-size: 14px; }',
        '.stats-bar { margin-left: auto; opacity: 0.7; font-size: 12px; }',
        '.hidden { display: none !important; }',
        '.rebuild-btn { background: var(--vscode-button-secondaryBackground, #3a3d41);',
        '  color: var(--vscode-button-secondaryForeground, #ccc); border: 1px solid var(--vscode-input-border, #555);',
        '  padding: 3px 10px; border-radius: 3px; cursor: pointer; font-size: 11px; }',
        '.rebuild-btn:hover { background: var(--vscode-button-secondaryHoverBackground, #505356); }',
        '.cache-indicator { font-size: 11px; opacity: 0.5; }',
        'select, input[type=text] { background: var(--vscode-input-background, #3c3c3c);',
        '  color: var(--vscode-input-foreground, #ccc); border: 1px solid var(--vscode-input-border, #555);',
        '  padding: 3px 6px; border-radius: 3px; }',

        // Tabs
        '.tab-bar { display: flex; gap: 2px; }',
        '.tab { background: none; border: none; color: var(--vscode-foreground, #ccc); padding: 4px 12px;',
        '  cursor: pointer; font-size: 12px; border-radius: 3px 3px 0 0; opacity: 0.6; }',
        '.tab:hover { opacity: 0.8; }',
        '.tab.active { opacity: 1; background: var(--vscode-editor-background, #1e1e1e);',
        '  border: 1px solid var(--vscode-panel-border, #444); border-bottom-color: transparent; }',

        // Tab content
        '.tab-content { display: none; flex: 1; overflow: hidden; }',
        '.tab-content.active { display: flex; flex-direction: column; }',

        // Main layout
        '.main { display: flex; flex: 1; overflow: hidden; }',

        // Creature panel (left)
        '.creature-panel { width: 220px; min-width: 220px; display: flex; flex-direction: column;',
        '  border-right: 1px solid var(--vscode-panel-border, #444); flex-shrink: 0; }',
        '.panel-header { font-weight: 600; font-size: 11px; text-transform: uppercase; padding: 8px 10px 4px;',
        '  color: var(--vscode-descriptionForeground, #888); display: flex; align-items: center; }',
        '.panel-header span { flex: 1; }',
        '.panel-close { background: none; border: none; color: var(--vscode-foreground, #ccc);',
        '  cursor: pointer; font-size: 16px; padding: 0 4px; line-height: 1; }',
        '.search-input { margin: 4px 8px 6px; padding: 4px 8px; font-size: 12px; }',
        '.creature-list { flex: 1; overflow-y: auto; }',
        '.creature-item { padding: 4px 10px; cursor: pointer; display: flex; align-items: center;',
        '  gap: 6px; font-size: 12px; border-left: 3px solid transparent; }',
        '.creature-item:hover { background: var(--vscode-list-hoverBackground, #2a2d2e); }',
        '.creature-item.selected { background: var(--vscode-list-activeSelectionBackground, #094771);',
        '  border-left-color: var(--vscode-textLink-foreground, #4fc1ff); }',
        '.creature-item .name { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }',
        '.creature-item .lvl { opacity: 0.6; font-size: 11px; white-space: nowrap; }',
        '.creature-item .rgn-count { font-size: 10px; opacity: 0.5; background: rgba(255,255,255,0.08);',
        '  padding: 1px 5px; border-radius: 8px; white-space: nowrap; }',
        '.empty-msg { padding: 12px; opacity: 0.5; font-size: 12px; text-align: center; }',

        // Filters
        '.filter-bar { display: flex; gap: 8px; padding: 2px 8px 4px; }',
        '.filter-toggle { font-size: 11px; cursor: pointer; display: flex; align-items: center; gap: 3px; }',
        '.filter-toggle input { margin: 0; }',
        '.cl-slider { padding: 2px 8px 4px; }',
        '.cl-slider label { font-size: 11px; opacity: 0.7; }',
        '.range-row { display: flex; gap: 4px; }',
        '.range-row input[type=range] { flex: 1; height: 14px; -webkit-appearance: none; appearance: none;',
        '  background: var(--vscode-input-background, #3c3c3c); border-radius: 3px; outline: none; }',
        '.range-row input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px;',
        '  background: var(--vscode-textLink-foreground, #4fc1ff); border-radius: 50%; cursor: pointer; }',
        '.creature-count { font-size: 10px; opacity: 0.5; padding: 0 10px 2px; }',

        // Canvas
        '.canvas-container { flex: 1; position: relative; overflow: hidden; }',
        'canvas { width: 100%; height: 100%; display: block; }',
        '.coords-overlay { position: absolute; bottom: 8px; left: 8px; font-size: 11px;',
        '  background: rgba(0,0,0,0.6); padding: 2px 6px; border-radius: 3px; pointer-events: none; }',

        // Region panel (right)
        '.region-panel { width: 0; overflow: hidden; transition: width 0.15s; flex-shrink: 0;',
        '  border-left: 1px solid transparent; display: flex; flex-direction: column; }',
        '.region-panel.open { width: 300px; border-left-color: var(--vscode-panel-border, #444); overflow-y: auto; }',
        '.region-content { padding: 8px 10px; font-size: 12px; }',
        '.region-content .meta { opacity: 0.7; margin-bottom: 6px; font-size: 11px; }',
        '.region-content .meta b { opacity: 1; }',
        '.region-content table { width: 100%; border-collapse: collapse; margin-top: 6px; }',
        '.region-content th { text-align: left; padding: 3px 6px; font-weight: 600; font-size: 11px;',
        '  border-bottom: 1px solid var(--vscode-panel-border, #444);',
        '  color: var(--vscode-descriptionForeground, #888); }',
        '.region-content td { padding: 3px 6px; }',
        '.region-content tr:hover td { background: var(--vscode-list-hoverBackground, #2a2d2e); }',
        '.boss-badge { color: #f97316; font-weight: 600; font-size: 10px; margin-left: 4px; }',
        '.link { color: var(--vscode-textLink-foreground, #4fc1ff); cursor: pointer; text-decoration: underline; }',
        '.flags-row { display: flex; gap: 4px; flex-wrap: wrap; margin: 4px 0; }',
        '.flag { font-size: 10px; padding: 1px 5px; border-radius: 3px; background: rgba(255,255,255,0.08); }',

        // Overlap navigation
        '.overlap-nav { display: flex; align-items: center; gap: 6px; padding: 4px 0 6px;',
        '  border-bottom: 1px solid var(--vscode-panel-border, #444); margin-bottom: 6px; }',
        '.overlap-btn { background: var(--vscode-button-secondaryBackground, #3a3d41);',
        '  color: var(--vscode-button-secondaryForeground, #ccc); border: 1px solid var(--vscode-input-border, #555);',
        '  padding: 2px 8px; border-radius: 3px; cursor: pointer; font-size: 11px; line-height: 1; }',
        '.overlap-btn:hover { background: var(--vscode-button-secondaryHoverBackground, #505356); }',
        '.overlap-label { font-size: 11px; opacity: 0.7; }',

        // Static spawn tab
        '.zoom-hint { position: absolute; top: 8px; right: 8px; font-size: 10px; opacity: 0.4;',
        '  background: rgba(0,0,0,0.5); padding: 2px 6px; border-radius: 3px; pointer-events: none; }',
        '.sp-group { margin-bottom: 2px; }',
        '.sp-group-header { font-size: 10px; font-weight: 600; text-transform: uppercase; padding: 6px 10px 2px;',
        '  color: var(--vscode-descriptionForeground, #888); position: sticky; top: 0;',
        '  background: var(--vscode-editor-background, #1e1e1e); }',
        '.sp-item { padding: 4px 10px; cursor: pointer; display: flex; align-items: center; gap: 6px;',
        '  font-size: 12px; border-left: 3px solid transparent; }',
        '.sp-item:hover { background: var(--vscode-list-hoverBackground, #2a2d2e); }',
        '.sp-item.selected { background: var(--vscode-list-activeSelectionBackground, #094771);',
        '  border-left-color: var(--vscode-textLink-foreground, #4fc1ff); }',
        '.sp-item .sp-name { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }',
        '.sp-item .sp-count { font-size: 10px; opacity: 0.5; background: rgba(255,255,255,0.08);',
        '  padding: 1px 5px; border-radius: 8px; white-space: nowrap; }',
        '.sp-cat-badge { font-size: 9px; padding: 1px 4px; border-radius: 3px; text-transform: uppercase;',
        '  font-weight: 600; margin-left: 4px; }',
        '.sp-cat-cave { background: rgba(168,85,247,0.2); color: #a855f7; }',
        '.sp-cat-poi { background: rgba(59,130,246,0.2); color: #3b82f6; }',
        '.sp-cat-city { background: rgba(34,197,94,0.2); color: #22c55e; }',
        '.sp-cat-static { background: rgba(234,179,8,0.2); color: #eab308; }',
        '.sp-cat-dungeon { background: rgba(239,68,68,0.2); color: #ef4444; }',
        '.sp-cat-custom { background: rgba(236,72,153,0.2); color: #ec4899; }',
        '.spawn-dot-legend { display: flex; gap: 10px; padding: 2px 10px 4px; font-size: 10px; opacity: 0.6; }',
        '.spawn-dot-legend span { display: flex; align-items: center; gap: 3px; }',
        '.legend-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }',

        // World spawn tab
        '.world-footer { padding: 4px 12px; font-size: 11px; opacity: 0.7;',
        '  background: var(--vscode-titleBar-activeBackground, #2d2d2d);',
        '  border-top: 1px solid var(--vscode-panel-border, #444); }',
        '.world-entry { padding: 5px 10px; cursor: pointer; border-left: 3px solid transparent;',
        '  font-size: 12px; }',
        '.world-entry:hover { background: var(--vscode-list-hoverBackground, #2a2d2e); }',
        '.world-entry.selected { background: var(--vscode-list-activeSelectionBackground, #094771);',
        '  border-left-color: var(--vscode-textLink-foreground, #4fc1ff); }',
        '.world-entry .we-header { display: flex; align-items: center; gap: 6px; }',
        '.world-entry .we-name { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; }',
        '.world-entry .we-pct { font-size: 11px; font-weight: 600; color: var(--vscode-textLink-foreground, #4fc1ff); min-width: 40px; text-align: right; }',
        '.world-entry .we-details { font-size: 10px; opacity: 0.6; padding-top: 1px; display: flex; gap: 8px; }',
        '.world-entry .we-bar { height: 2px; background: var(--vscode-input-background, #3c3c3c);',
        '  border-radius: 1px; margin-top: 2px; }',
        '.world-entry .we-bar-fill { height: 100%; border-radius: 1px;',
        '  background: var(--vscode-textLink-foreground, #4fc1ff); }',
        '.world-legend { display: flex; gap: 12px; padding: 4px 10px 6px; font-size: 10px; opacity: 0.6; }',
        '.world-legend span { display: flex; align-items: center; gap: 3px; }',
        '.wl-dot { width: 10px; height: 10px; border-radius: 2px; display: inline-block; }',
        '.wl-nospawn { background: rgba(239,68,68,0.4); }',
        '.wl-noworld { background: rgba(249,115,22,0.4); }',
        '.wl-city { background: rgba(59,130,246,0.4); }',

        // Reports
        '.reports-container { flex: 1; overflow-y: auto; padding: 12px 16px; }',
        '.report-section { margin-bottom: 20px; }',
        '.report-section h3 { font-size: 13px; font-weight: 600; margin-bottom: 6px;',
        '  padding-bottom: 4px; border-bottom: 1px solid var(--vscode-panel-border, #444); }',
        '.report-section .report-count { font-weight: normal; opacity: 0.5; }',
        '.report-table { width: 100%; border-collapse: collapse; font-size: 12px; }',
        '.report-table th { text-align: left; padding: 3px 8px; font-weight: 600; font-size: 11px;',
        '  color: var(--vscode-descriptionForeground, #888); border-bottom: 1px solid var(--vscode-panel-border, #444); }',
        '.report-table td { padding: 3px 8px; }',
        '.report-table tr:hover td { background: var(--vscode-list-hoverBackground, #2a2d2e); }',
        '.report-table .warn { color: #f97316; }',
    ].join('\n');
}

function getScript(): string {
    return [
        'var vscode = acquireVsCodeApi();',
        'var planetData = null;',
        'var cellPositionMap = {};',
        'var selectedCreatureName = null;',
        'var selectedRegionIdx = -1;',
        'var creatureRegionMap = {};',
        'var creatureHeatMap = {};',   // { creatureName: { regionIdx: heatValue 0-1 } }
        'var allCreatures = [];',
        '',
        '// Filter state',
        'var filterSpawned = true;',
        'var filterBabies = false;',
        'var filterNpcs = false;',
        'var clMin = 1, clMax = 300;',
        '',
        '// Canvas state',
        'var canvas, ctx;',
        'var viewX = 0, viewZ = 0, zoom = 0.035;',
        'var isDragging = false, dragStartX = 0, dragStartY = 0, dragViewX = 0, dragViewZ = 0;',
        '',
        '// Overlap cycling state',
        'var lastClickHits = [];',   // region indices at last click point
        'var lastClickHitIdx = 0;',  // current index within lastClickHits
        'var lastClickWX = 0, lastClickWZ = 0;', // world coords of last click
        '',
        'function hexToRgba(hex, alpha) {',
        '  var r = parseInt(hex.slice(1,3), 16);',
        '  var g = parseInt(hex.slice(3,5), 16);',
        '  var b = parseInt(hex.slice(5,7), 16);',
        '  return "rgba("+r+","+g+","+b+","+alpha+")";',
        '}',
        '',
        '// Heatmap color: 0 = cool blue, 0.5 = yellow, 1.0 = hot red. Returns #rrggbb hex.',
        'function heatColor(t) {',
        '  var r, g, b;',
        '  if (t <= 0.5) {',
        '    r = Math.round(0 + t * 2 * 255);',
        '    g = Math.round(100 + t * 2 * 155);',
        '    b = Math.round(255 - t * 2 * 255);',
        '  } else {',
        '    var t2 = (t - 0.5) * 2;',
        '    r = 255;',
        '    g = Math.round(255 - t2 * 255);',
        '    b = 0;',
        '  }',
        '  return "#" + (r < 16 ? "0" : "") + r.toString(16) + (g < 16 ? "0" : "") + g.toString(16) + (b < 16 ? "0" : "") + b.toString(16);',
        '}',
        '',
        'function difficultyColor(minD, maxD) {',
        '  var avg = (minD + maxD) / 2;',
        '  if (avg <= 10) return "#22c55e";',
        '  if (avg <= 20) return "#eab308";',
        '  if (avg <= 30) return "#f97316";',
        '  return "#ef4444";',
        '}',
        '',
        '// ── Init ──',
        'document.addEventListener("DOMContentLoaded", function() {',
        '  canvas = document.getElementById("mapCanvas");',
        '  ctx = canvas.getContext("2d");',
        '  resizeCanvas();',
        '  window.addEventListener("resize", function() { resizeCanvas(); render(); });',
        '  var resizeCheck = setInterval(function() {',
        '    var c = canvas.parentElement;',
        '    if (c.clientWidth > 0 && c.clientHeight > 0) {',
        '      clearInterval(resizeCheck);',
        '      resizeCanvas();',
        '      if (planetData) { fitToView(); }',
        '      render();',
        '    }',
        '  }, 100);',
        '  setupCanvasEvents();',
        '  setupControls();',
        '  render();',
        '  initStaticCanvas();',
        '  initWorldCanvas();',
        '});',
        '',
        'function resizeCanvas() {',
        '  var container = canvas.parentElement;',
        '  var w = container.clientWidth;',
        '  var h = container.clientHeight;',
        '  if (w > 0 && h > 0) { canvas.width = w; canvas.height = h; }',
        '}',
        '',
        '// ── Controls ──',
        'function setupControls() {',
        '  document.getElementById("planetSelect").addEventListener("change", function(e) {',
        '    var planet = e.target.value;',
        '    if (planet) vscode.postMessage({ type: "loadPlanet", planet: planet });',
        '  });',
        '',
        '  document.getElementById("rebuildBtn").addEventListener("click", function() {',
        '    var planet = document.getElementById("planetSelect").value;',
        '    if (planet) vscode.postMessage({ type: "rebuildPlanet", planet: planet });',
        '  });',
        '',
        '  document.querySelectorAll(".tab").forEach(function(btn) {',
        '    btn.addEventListener("click", function() {',
        '      document.querySelectorAll(".tab").forEach(function(t) { t.classList.remove("active"); });',
        '      document.querySelectorAll(".tab-content").forEach(function(c) { c.classList.remove("active"); });',
        '      btn.classList.add("active");',
        '      var tabMap = { map: "tabMap", world: "tabWorld", static: "tabStatic", reports: "tabReports" };',
        '      var tabId = tabMap[btn.dataset.tab] || "tabMap";',
        '      document.getElementById(tabId).classList.add("active");',
        '      if (btn.dataset.tab === "map") { resizeCanvas(); render(); }',
        '      if (btn.dataset.tab === "world") { resizeWorldCanvas(); renderWorldMap(); }',
        '      if (btn.dataset.tab === "static") { resizeStaticCanvas(); renderStatic(); }',
        '    });',
        '  });',
        '',
        '  document.getElementById("creatureSearch").addEventListener("input", function() { populateCreatureList(); });',
        '',
        '  // Filters',
        '  document.getElementById("fSpawned").addEventListener("change", function(e) {',
        '    filterSpawned = e.target.checked;',
        '    populateCreatureList();',
        '  });',
        '  document.getElementById("fBabies").addEventListener("change", function(e) {',
        '    filterBabies = e.target.checked;',
        '    populateCreatureList();',
        '  });',
        '  document.getElementById("fNpcs").addEventListener("change", function(e) {',
        '    filterNpcs = e.target.checked;',
        '    populateCreatureList();',
        '  });',
        '  document.getElementById("clMin").addEventListener("input", function(e) {',
        '    clMin = parseInt(e.target.value);',
        '    if (clMin > clMax) { clMax = clMin; document.getElementById("clMax").value = clMax; }',
        '    document.getElementById("clMinLabel").textContent = clMin;',
        '    document.getElementById("clMaxLabel").textContent = clMax;',
        '    populateCreatureList();',
        '  });',
        '  document.getElementById("clMax").addEventListener("input", function(e) {',
        '    clMax = parseInt(e.target.value);',
        '    if (clMax < clMin) { clMin = clMax; document.getElementById("clMin").value = clMin; }',
        '    document.getElementById("clMinLabel").textContent = clMin;',
        '    document.getElementById("clMaxLabel").textContent = clMax;',
        '    populateCreatureList();',
        '  });',
        '',
        '  document.getElementById("regionClose").addEventListener("click", function() { closeRegionPanel(); });',
        '',
        '  document.getElementById("regionContent").addEventListener("click", function(e) {',
        '    var el = e.target;',
        '    while (el && el !== this) {',
        '      if (el.dataset && el.dataset.file) {',
        '        vscode.postMessage({ type: "openFile", path: el.dataset.file });',
        '        return;',
        '      }',
        '      el = el.parentElement;',
        '    }',
        '  });',
        '}',
        '',
        'function closeRegionPanel() {',
        '  document.getElementById("regionPanel").classList.remove("open");',
        '  selectedRegionIdx = -1;',
        '  lastClickHits = [];',
        '  lastClickHitIdx = 0;',
        '  resizeCanvas();',
        '  render();',
        '}',
        '',
        '// ── Message handler ──',
        'window.addEventListener("message", function(event) {',
        '  var msg = event.data;',
        '  if (msg.type === "loading") {',
        '    document.getElementById("loadingIndicator").classList.remove("hidden");',
        '    document.getElementById("loadingIndicator").textContent = "Loading...";',
        '    document.getElementById("cacheIndicator").classList.add("hidden");',
        '    document.getElementById("creatureList").innerHTML = "<div class=\\"empty-msg\\">Loading...</div>";',
        '    document.getElementById("creatureCount").textContent = "";',
        '  } else if (msg.type === "status") {',
        '    document.getElementById("loadingIndicator").textContent = msg.text;',
        '  } else if (msg.type === "regions") {',
        '    planetData = { planetName: msg.planetName, regions: msg.regions,',
        '      spawnGroups: {}, lairTemplates: {}, creatures: {}, missingCreatures: [], warnings: [] };',
        '    selectedRegionIdx = -1;',
        '    selectedCreatureName = null;',
        '    closeRegionPanel();',
        '    resizeCanvas();',
        '    fitToView();',
        '    render();',
        '    document.getElementById("statsBar").textContent = "Regions: " + msg.regions.length + "  (loading details...)";',
        '    document.getElementById("creatureList").innerHTML = "<div class=\\"empty-msg\\">Loading creature data...</div>";',
        '  } else if (msg.type === "planetData") {',
        '    document.getElementById("loadingIndicator").classList.add("hidden");',
        '    planetData = msg.data;',
        '    cellPositionMap = msg.cellMap || {};',
        '    buildCreatureRegionMap();',
        '    populateCreatureList();',
        '    buildReports();',
        '    populateStaticList();',
        '    updateWorldTab();',
        '    updateStats();',
        '    render();',
        '    resizeStaticCanvas();',
        '    sFitToView();',
        '    renderStatic();',
        '    document.getElementById("rebuildBtn").classList.remove("hidden");',
        '    var ci = document.getElementById("cacheIndicator");',
        '    if (msg.cachedAt) {',
        '      var age = timeSince(msg.cachedAt);',
        '      ci.textContent = msg.cached ? "(cached " + age + ")" : "(just rebuilt)";',
        '      ci.classList.remove("hidden");',
        '    }',
        '  } else if (msg.type === "error") {',
        '    document.getElementById("loadingIndicator").textContent = "Error: " + msg.message;',
        '  }',
        '});',
        '',
        '// ── Creature-Region Index + Spawn Probability ──',
        'function buildCreatureRegionMap() {',
        '  creatureRegionMap = {};',
        '  creatureHeatMap = {};',
        '  if (!planetData) return;',
        '',
        '  // Build creature → region mapping with real spawn probability per region',
        '  // P = SUM over lairs containing creature: (lair_wt/group_total_wt) * (mob_wt/lair_total_wt)',
        '  // Boss mobiles use a flat 20% chance (default bossMobileChance)',
        '  for (var i = 0; i < planetData.regions.length; i++) {',
        '    var r = planetData.regions[i];',
        '    if (!r.isSpawnArea) continue;',
        '    for (var gi = 0; gi < r.spawnGroups.length; gi++) {',
        '      var group = planetData.spawnGroups[r.spawnGroups[gi]];',
        '      if (!group) continue;',
        '      var totalGroupWeight = 0;',
        '      for (var tw = 0; tw < group.lairSpawns.length; tw++) totalGroupWeight += group.lairSpawns[tw].weighting;',
        '      if (totalGroupWeight === 0) continue;',
        '',
        '      for (var li = 0; li < group.lairSpawns.length; li++) {',
        '        var ls = group.lairSpawns[li];',
        '        var lair = planetData.lairTemplates[ls.lairTemplateName];',
        '        if (!lair) continue;',
        '        var lairSelectPct = ls.weighting / totalGroupWeight;',
        '',
        '        // Regular mobiles: weighted random selection',
        '        var totalMobWeight = 0;',
        '        for (var mw = 0; mw < lair.mobiles.length; mw++) totalMobWeight += lair.mobiles[mw].weight;',
        '',
        '        for (var mi = 0; mi < lair.mobiles.length; mi++) {',
        '          var mob = lair.mobiles[mi];',
        '          var mobPct = totalMobWeight > 0 ? mob.weight / totalMobWeight : 0;',
        '          var spawnPct = lairSelectPct * mobPct;',
        '          addCreatureHeat(mob.name, i, spawnPct);',
        '        }',
        '',
        '        // Boss mobiles: flat chance (default 20%) at wave 4, all bosses spawn together',
        '        var bossChance = lair.bossMobileChance > 0 ? lair.bossMobileChance / 100 : 0.2;',
        '        for (var bi = 0; bi < lair.bossMobiles.length; bi++) {',
        '          var boss = lair.bossMobiles[bi];',
        '          var bossPct = lairSelectPct * bossChance;',
        '          addCreatureHeat(boss.name, i, bossPct);',
        '        }',
        '      }',
        '    }',
        '  }',
        '',
        '  function addCreatureHeat(name, regionIdx, pct) {',
        '    if (!creatureRegionMap[name]) creatureRegionMap[name] = [];',
        '    if (creatureRegionMap[name].indexOf(regionIdx) === -1) creatureRegionMap[name].push(regionIdx);',
        '    if (!creatureHeatMap[name]) creatureHeatMap[name] = {};',
        '    // Sum probability across multiple lairs in the same region',
        '    creatureHeatMap[name][regionIdx] = (creatureHeatMap[name][regionIdx] || 0) + pct;',
        '  }',
        '',
        '  // Build sorted creature list',
        '  allCreatures = [];',
        '  var seen = {};',
        '  var names = Object.keys(planetData.creatures);',
        '  for (var ci = 0; ci < names.length; ci++) {',
        '    var cn = names[ci];',
        '    if (seen[cn]) continue;',
        '    seen[cn] = true;',
        '    var c = planetData.creatures[cn];',
        '    var rc = creatureRegionMap[cn] ? creatureRegionMap[cn].length : 0;',
        '    allCreatures.push({ name: cn, level: c.level, regionCount: rc, sourceFile: c.sourceFile,',
        '      tamingChance: c.tamingChance || 0, mobType: c.mobType || 0 });',
        '  }',
        '  allCreatures.sort(function(a, b) { return a.name < b.name ? -1 : a.name > b.name ? 1 : 0; });',
        '}',
        '',
        'function populateCreatureList() {',
        '  var list = document.getElementById("creatureList");',
        '  var search = document.getElementById("creatureSearch").value.toLowerCase();',
        '  if (allCreatures.length === 0) {',
        '    list.innerHTML = "<div class=\\"empty-msg\\">No creature data loaded</div>";',
        '    document.getElementById("creatureCount").textContent = "";',
        '    return;',
        '  }',
        '  var html = [];',
        '  var count = 0;',
        '  for (var i = 0; i < allCreatures.length; i++) {',
        '    var c = allCreatures[i];',
        '    // Apply filters',
        '    if (search && c.name.indexOf(search) === -1) continue;',
        '    if (filterSpawned && c.regionCount === 0) continue;',
        '    if (filterBabies && c.tamingChance <= 0) continue;',
        '    if (filterNpcs && c.mobType !== 3) continue;',
        '    if (c.level < clMin || c.level > clMax) continue;',
        '',
        '    var sel = (c.name === selectedCreatureName) ? " selected" : "";',
        '    var tameTag = c.tamingChance > 0 ? " <span style=\\"color:#22c55e;font-size:10px\\">[T]</span>" : "";',
        '    var npcTag = c.mobType === 3 ? " <span style=\\"color:#8b5cf6;font-size:10px\\">[NPC]</span>" : "";',
        '    html.push("<div class=\\"creature-item" + sel + "\\" data-creature=\\"" + escapeHtml(c.name) + "\\">",',
        '      "<span class=\\"name\\">" + escapeHtml(c.name.replace(/_/g, " ")) + tameTag + npcTag + "</span>",',
        '      "<span class=\\"lvl\\">L" + c.level + "</span>",',
        '      c.regionCount > 0 ? "<span class=\\"rgn-count\\">" + c.regionCount + " rgn</span>" : "<span class=\\"rgn-count\\" style=\\"color:#ef4444\\">0</span>",',
        '      "</div>");',
        '    count++;',
        '  }',
        '  document.getElementById("creatureCount").textContent = count + " / " + allCreatures.length;',
        '  if (count === 0) {',
        '    list.innerHTML = "<div class=\\"empty-msg\\">No matches</div>";',
        '  } else {',
        '    list.innerHTML = html.join("");',
        '  }',
        '  list.querySelectorAll(".creature-item").forEach(function(el) {',
        '    el.addEventListener("click", function() {',
        '      var name = el.dataset.creature;',
        '      selectCreature(name === selectedCreatureName ? null : name);',
        '    });',
        '  });',
        '}',
        '',
        'function selectCreature(name) {',
        '  selectedCreatureName = name;',
        '  selectedRegionIdx = -1;',
        '  document.getElementById("regionPanel").classList.remove("open");',
        '  document.querySelectorAll(".creature-item").forEach(function(el) {',
        '    el.classList.toggle("selected", el.dataset.creature === name);',
        '  });',
        '  resizeCanvas();',
        '  render();',
        '}',
        '',
        'function updateStats() {',
        '  if (!planetData) return;',
        '  var spawnRegions = planetData.regions.filter(function(r) { return r.isSpawnArea; }).length;',
        '  var groups = Object.keys(planetData.spawnGroups).length;',
        '  var lairs = Object.keys(planetData.lairTemplates).length;',
        '  var creatures = Object.keys(planetData.creatures).length;',
        '  var staticCount = planetData.staticSpawns ? planetData.staticSpawns.reduce(function(a, s) { return a + s.spawns.length; }, 0) : 0;',
        '  var worldCount = worldEntries.length;',
        '  document.getElementById("statsBar").textContent =',
        '    spawnRegions + " regions  " + groups + " groups  " + lairs + " lairs  " + creatures + " creatures"',
        '    + (worldCount > 0 ? "  " + worldCount + " world" : "")',
        '    + (staticCount > 0 ? "  " + staticCount + " static" : "");',
        '}',
        '',
        '// ── Canvas events ──',
        'function setupCanvasEvents() {',
        '  canvas.addEventListener("mousedown", function(e) {',
        '    if (e.button === 0) {',
        '      isDragging = true;',
        '      dragStartX = e.clientX; dragStartY = e.clientY;',
        '      dragViewX = viewX; dragViewZ = viewZ;',
        '      canvas.style.cursor = "grabbing";',
        '    }',
        '  });',
        '  window.addEventListener("mousemove", function(e) {',
        '    if (isDragging) {',
        '      viewX = dragViewX - (e.clientX - dragStartX) / zoom;',
        '      viewZ = dragViewZ + (e.clientY - dragStartY) / zoom;',
        '      render();',
        '    }',
        '    if (canvas) {',
        '      var rect = canvas.getBoundingClientRect();',
        '      var w = screenToWorld(e.clientX - rect.left, e.clientY - rect.top);',
        '      document.getElementById("coordsOverlay").textContent = Math.round(w.x) + ", " + Math.round(w.z);',
        '    }',
        '  });',
        '  window.addEventListener("mouseup", function() {',
        '    isDragging = false;',
        '    if (canvas) canvas.style.cursor = "crosshair";',
        '  });',
        '  canvas.addEventListener("wheel", function(e) {',
        '    e.preventDefault();',
        '    var rect = canvas.getBoundingClientRect();',
        '    var mx = e.clientX - rect.left, my = e.clientY - rect.top;',
        '    var wBefore = screenToWorld(mx, my);',
        '    var factor = e.deltaY < 0 ? 1.15 : 1 / 1.15;',
        '    var minZoom = Math.min(canvas.width, canvas.height) / 16000 * 0.9;',
        '    zoom = Math.max(minZoom, Math.min(2, zoom * factor));',
        '    var wAfter = screenToWorld(mx, my);',
        '    viewX -= (wAfter.x - wBefore.x);',
        '    viewZ -= (wAfter.z - wBefore.z);',
        '    render();',
        '  });',
        '  canvas.addEventListener("click", function(e) {',
        '    if (!planetData) return;',
        '    var rect = canvas.getBoundingClientRect();',
        '    var w = screenToWorld(e.clientX - rect.left, e.clientY - rect.top);',
        '    handleMapClick(w.x, w.z);',
        '  });',
        '  canvas.style.cursor = "crosshair";',
        '}',
        '',
        'function worldToScreen(wx, wz) {',
        '  return { x: canvas.width / 2 + (wx - viewX) * zoom, y: canvas.height / 2 - (wz - viewZ) * zoom };',
        '}',
        'function screenToWorld(sx, sy) {',
        '  return { x: viewX + (sx - canvas.width / 2) / zoom, z: viewZ - (sy - canvas.height / 2) / zoom };',
        '}',
        'function fitToView() {',
        '  viewX = 0; viewZ = 0;',
        '  zoom = Math.min(canvas.width, canvas.height) / 16000 * 0.9;',
        '}',
        '',
        '// ── Render ──',
        'function render() {',
        '  if (!ctx) return;',
        '  ctx.fillStyle = "#1a1a2e";',
        '  ctx.fillRect(0, 0, canvas.width, canvas.height);',
        '  drawGrid();',
        '  drawMapBoundary();',
        '  if (planetData) drawRegions();',
        '}',
        '',
        'function drawGrid() {',
        '  var gridSize = 1000;',
        '  var tl = screenToWorld(0, 0);',
        '  var br = screenToWorld(canvas.width, canvas.height);',
        '  var minX = Math.floor(Math.min(tl.x, br.x) / gridSize) * gridSize;',
        '  var maxX = Math.ceil(Math.max(tl.x, br.x) / gridSize) * gridSize;',
        '  var minZ = Math.floor(Math.min(tl.z, br.z) / gridSize) * gridSize;',
        '  var maxZ = Math.ceil(Math.max(tl.z, br.z) / gridSize) * gridSize;',
        '  ctx.strokeStyle = "rgba(255,255,255,0.06)"; ctx.lineWidth = 1;',
        '  for (var x = minX; x <= maxX; x += gridSize) {',
        '    var s = worldToScreen(x, 0);',
        '    ctx.beginPath(); ctx.moveTo(s.x, 0); ctx.lineTo(s.x, canvas.height); ctx.stroke();',
        '  }',
        '  for (var z = minZ; z <= maxZ; z += gridSize) {',
        '    var s = worldToScreen(0, z);',
        '    ctx.beginPath(); ctx.moveTo(0, s.y); ctx.lineTo(canvas.width, s.y); ctx.stroke();',
        '  }',
        '  ctx.strokeStyle = "rgba(255,255,255,0.15)";',
        '  var ox = worldToScreen(0, 0);',
        '  ctx.beginPath(); ctx.moveTo(ox.x, 0); ctx.lineTo(ox.x, canvas.height); ctx.stroke();',
        '  ctx.beginPath(); ctx.moveTo(0, ox.y); ctx.lineTo(canvas.width, ox.y); ctx.stroke();',
        '}',
        '',
        'function drawMapBoundary() {',
        '  var tl = worldToScreen(-8000, 8000);',
        '  var br = worldToScreen(8000, -8000);',
        '  ctx.strokeStyle = "rgba(255,255,255,0.2)"; ctx.lineWidth = 2;',
        '  ctx.strokeRect(tl.x, tl.y, br.x - tl.x, br.y - tl.y);',
        '}',
        '',
        'function drawRegions() {',
        '  var regions = planetData.regions;',
        '  var heatMode = selectedCreatureName && creatureHeatMap[selectedCreatureName];',
        '  var heatData = heatMode ? creatureHeatMap[selectedCreatureName] : null;',
        '',
        '  // Find max heat for normalization (so highest region = hottest color)',
        '  var maxHeat = 0;',
        '  if (heatData) {',
        '    for (var k in heatData) { if (heatData[k] > maxHeat) maxHeat = heatData[k]; }',
        '  }',
        '  if (maxHeat <= 0) maxHeat = 1;',
        '',
        '  // Draw in passes: background, spawn areas, selected',
        '  for (var pass = 0; pass < 3; pass++) {',
        '    for (var i = 0; i < regions.length; i++) {',
        '      var r = regions[i];',
        '      var isSelected = (i === selectedRegionIdx);',
        '      var isSpawn = r.isSpawnArea;',
        '      if (pass === 0 && isSpawn) continue;',
        '      if (pass === 1 && (!isSpawn || isSelected)) continue;',
        '      if (pass === 2 && !isSelected) continue;',
        '      if (!isSpawn && !r.isCity && !r.isNoSpawnArea) continue;',
        '      drawRegion(r, i, isSelected, heatData, maxHeat);',
        '    }',
        '  }',
        '',
        '  // Spawn % labels in heatmap mode',
        '  if (heatData) {',
        '    ctx.font = "bold 12px sans-serif"; ctx.textAlign = "center"; ctx.textBaseline = "middle";',
        '    for (var i = 0; i < regions.length; i++) {',
        '      var pct = heatData[i];',
        '      if (pct === undefined) continue;',
        '      var r = regions[i];',
        '      var cx = r.x, cy = r.y;',
        '      if (r.shape.type === "rectangle") { cx = (r.x + r.shape.x2) / 2; cy = (r.y + r.shape.y2) / 2; }',
        '      var center = worldToScreen(cx, cy);',
        '      var pctVal = pct * 100;',
        '      var label = pctVal < 0.1 ? "<0.1%" : pctVal < 1 ? pctVal.toFixed(1) + "%" : Math.round(pctVal) + "%";',
        '      ctx.fillStyle = "rgba(0,0,0,0.7)";',
        '      var tw = ctx.measureText(label).width;',
        '      ctx.fillRect(center.x - tw/2 - 4, center.y - 8, tw + 8, 16);',
        '      ctx.fillStyle = "#fff";',
        '      ctx.fillText(label, center.x, center.y);',
        '    }',
        '  }',
        '',
        '  // City labels',
        '  ctx.font = "11px sans-serif"; ctx.textAlign = "center"; ctx.textBaseline = "middle";',
        '  for (var i = 0; i < regions.length; i++) {',
        '    var r = regions[i];',
        '    if (!r.isCity) continue;',
        '    var center = worldToScreen(r.x, r.y);',
        '    ctx.fillStyle = "rgba(255,255,255,0.8)";',
        '    ctx.fillText(r.name.replace(/@[^:]+:/, "").replace(/_/g, " "), center.x, center.y);',
        '  }',
        '}',
        '',
        'function getRegionColor(r) {',
        '  if (r.isCity) return "#3b82f6";',
        '  if (r.isNoSpawnArea) return "#6b7280";',
        '  if (!r.isSpawnArea) return "#6b7280";',
        '  var avgMin = 0, avgMax = 0, count = 0;',
        '  if (planetData) {',
        '    for (var gi = 0; gi < r.spawnGroups.length; gi++) {',
        '      var group = planetData.spawnGroups[r.spawnGroups[gi]];',
        '      if (!group) continue;',
        '      for (var li = 0; li < group.lairSpawns.length; li++) {',
        '        avgMin += group.lairSpawns[li].minDifficulty;',
        '        avgMax += group.lairSpawns[li].maxDifficulty;',
        '        count++;',
        '      }',
        '    }',
        '  }',
        '  if (count === 0) return "#6b7280";',
        '  return difficultyColor(avgMin/count, avgMax/count);',
        '}',
        '',
        'function drawRegion(r, idx, isSelected, heatData, maxHeat) {',
        '  var fillAlpha, strokeAlpha, lineW, color;',
        '',
        '  if (heatData) {',
        '    // Heatmap mode: color by spawn probability, normalized to max',
        '    var rawPct = heatData[idx];',
        '    var t = rawPct !== undefined ? rawPct / maxHeat : undefined;',
        '    if (isSelected) {',
        '      color = t !== undefined ? heatColor(t) : "#6b7280";',
        '      fillAlpha = 0.8; strokeAlpha = 1.0; lineW = 3;',
        '    } else if (t !== undefined) {',
        '      color = heatColor(t);',
        '      fillAlpha = 0.4 + t * 0.35;',
        '      strokeAlpha = 1.0;',
        '      lineW = 2.5 + t * 2;',
        '    } else {',
        '      color = "#6b7280";',
        '      fillAlpha = 0.02; strokeAlpha = 0.06; lineW = 0.5;',
        '    }',
        '  } else {',
        '    color = getRegionColor(r);',
        '    if (isSelected) {',
        '      fillAlpha = 0.5; strokeAlpha = 1.0; lineW = 3;',
        '    } else {',
        '      fillAlpha = r.isSpawnArea ? 0.25 : 0.1;',
        '      strokeAlpha = 0.7; lineW = 1.5;',
        '    }',
        '  }',
        '',
        '  ctx.fillStyle = hexToRgba(color, fillAlpha);',
        '  ctx.strokeStyle = hexToRgba(color, strokeAlpha);',
        '  ctx.lineWidth = lineW;',
        '  ctx.setLineDash(!r.isSpawnArea && !r.isCity && !r.isNoSpawnArea ? [6, 4] : []);',
        '',
        '  var shape = r.shape;',
        '  if (shape.type === "circle") {',
        '    var center = worldToScreen(r.x, r.y);',
        '    var radiusPx = shape.radius * zoom;',
        '    ctx.beginPath(); ctx.arc(center.x, center.y, radiusPx, 0, Math.PI * 2);',
        '    ctx.fill(); ctx.stroke();',
        '  } else if (shape.type === "rectangle") {',
        '    var p1 = worldToScreen(r.x, r.y);',
        '    var p2 = worldToScreen(shape.x2, shape.y2);',
        '    var rx = Math.min(p1.x, p2.x), ry = Math.min(p1.y, p2.y);',
        '    var rw = Math.abs(p2.x - p1.x), rh = Math.abs(p2.y - p1.y);',
        '    ctx.fillRect(rx, ry, rw, rh); ctx.strokeRect(rx, ry, rw, rh);',
        '  } else if (shape.type === "ring") {',
        '    var center = worldToScreen(r.x, r.y);',
        '    var outerPx = shape.outerRadius * zoom;',
        '    var innerPx = shape.innerRadius * zoom;',
        '    ctx.beginPath();',
        '    ctx.arc(center.x, center.y, outerPx, 0, Math.PI * 2);',
        '    ctx.arc(center.x, center.y, innerPx, 0, Math.PI * 2, true);',
        '    ctx.fill();',
        '    ctx.beginPath(); ctx.arc(center.x, center.y, outerPx, 0, Math.PI * 2); ctx.stroke();',
        '    ctx.beginPath(); ctx.arc(center.x, center.y, innerPx, 0, Math.PI * 2); ctx.stroke();',
        '  }',
        '  ctx.setLineDash([]);',
        '}',
        '',
        '// ── Click handling ──',
        'function handleMapClick(wx, wz) {',
        '  if (selectedCreatureName) { selectCreature(null); return; }',
        '',
        '  // Check if clicking same spot as last time (within 10 world units)',
        '  var dx = wx - lastClickWX, dz = wz - lastClickWZ;',
        '  var sameSpot = (dx*dx + dz*dz) < 100;',
        '',
        '  if (sameSpot && lastClickHits.length > 1) {',
        '    // Cycle to next region at this spot',
        '    lastClickHitIdx = (lastClickHitIdx + 1) % lastClickHits.length;',
        '    selectedRegionIdx = lastClickHits[lastClickHitIdx];',
        '    selectedCreatureName = null;',
        '    showRegionDetail(planetData.regions[selectedRegionIdx], lastClickHits, lastClickHitIdx);',
        '    render();',
        '    return;',
        '  }',
        '',
        '  // New click location — find all regions here',
        '  var hits = [];',
        '  for (var i = 0; i < planetData.regions.length; i++) {',
        '    var r = planetData.regions[i];',
        '    if (!r.isSpawnArea && !r.isCity) continue;',
        '    if (pointInRegion(wx, wz, r)) hits.push(i);',
        '  }',
        '  if (hits.length === 0) { closeRegionPanel(); lastClickHits = []; return; }',
        '  hits.sort(function(a, b) {',
        '    var ra = planetData.regions[a], rb = planetData.regions[b];',
        '    if (ra.isSpawnArea !== rb.isSpawnArea) return ra.isSpawnArea ? -1 : 1;',
        '    return regionArea(ra) - regionArea(rb);',
        '  });',
        '',
        '  lastClickHits = hits;',
        '  lastClickHitIdx = 0;',
        '  lastClickWX = wx;',
        '  lastClickWZ = wz;',
        '',
        '  selectedRegionIdx = hits[0];',
        '  selectedCreatureName = null;',
        '  showRegionDetail(planetData.regions[selectedRegionIdx], hits, 0);',
        '  render();',
        '}',
        '',
        'function cycleRegion(delta) {',
        '  if (lastClickHits.length <= 1) return;',
        '  lastClickHitIdx = (lastClickHitIdx + delta + lastClickHits.length) % lastClickHits.length;',
        '  selectedRegionIdx = lastClickHits[lastClickHitIdx];',
        '  selectedCreatureName = null;',
        '  showRegionDetail(planetData.regions[selectedRegionIdx], lastClickHits, lastClickHitIdx);',
        '  render();',
        '}',
        '',
        'function pointInRegion(wx, wz, r) {',
        '  var shape = r.shape;',
        '  if (shape.type === "circle") {',
        '    var dx = wx - r.x, dz = wz - r.y;',
        '    return (dx*dx + dz*dz) <= shape.radius * shape.radius;',
        '  } else if (shape.type === "rectangle") {',
        '    return wx >= Math.min(r.x, shape.x2) && wx <= Math.max(r.x, shape.x2)',
        '      && wz >= Math.min(r.y, shape.y2) && wz <= Math.max(r.y, shape.y2);',
        '  } else if (shape.type === "ring") {',
        '    var dx = wx - r.x, dz = wz - r.y;',
        '    var dist2 = dx*dx + dz*dz;',
        '    return dist2 >= shape.innerRadius * shape.innerRadius && dist2 <= shape.outerRadius * shape.outerRadius;',
        '  }',
        '  return false;',
        '}',
        '',
        'function regionArea(r) {',
        '  var s = r.shape;',
        '  if (s.type === "circle") return Math.PI * s.radius * s.radius;',
        '  if (s.type === "rectangle") return Math.abs(s.x2 - r.x) * Math.abs(s.y2 - r.y);',
        '  if (s.type === "ring") return Math.PI * (s.outerRadius * s.outerRadius - s.innerRadius * s.innerRadius);',
        '  return Infinity;',
        '}',
        '',
        '// ── Region detail panel (right) ──',
        'function showRegionDetail(r, hits, hitIdx) {',
        '  var panel = document.getElementById("regionPanel");',
        '  panel.classList.add("open");',
        '  document.getElementById("regionTitle").textContent = r.name.replace(/@[^:]+:/, "").replace(/_/g, " ");',
        '',
        '  var html = [];',
        '',
        '  // Overlap navigator (shown when multiple regions at click point)',
        '  if (hits && hits.length > 1) {',
        '    html.push("<div class=\\"overlap-nav\\">");',
        '    html.push("  <button class=\\"overlap-btn\\" id=\\"overlapPrev\\" title=\\"Previous region\\">&#9664;</button>");',
        '    html.push("  <span class=\\"overlap-label\\">" + (hitIdx + 1) + " of " + hits.length + " overlapping</span>");',
        '    html.push("  <button class=\\"overlap-btn\\" id=\\"overlapNext\\" title=\\"Next region\\">&#9654;</button>");',
        '    html.push("</div>");',
        '  }',
        '',
        '  html.push("<div class=\\"meta\\">");',
        '  html.push("<div><b>Shape:</b> " + describeShape(r) + "</div>");',
        '  html.push("<div><b>Max Spawns:</b> " + r.maxSpawnLimit + "</div>");',
        '  html.push("</div>");',
        '',
        '  var flags = [];',
        '  if (r.isSpawnArea) flags.push("SPAWN");',
        '  if (r.isNoSpawnArea) flags.push("NO-SPAWN");',
        '  if (r.isWorldSpawn) flags.push("WORLD");',
        '  if (r.isCity) flags.push("CITY");',
        '  if (r.isNoBuildZone) flags.push("NO-BUILD");',
        '  if (r.isNamedRegion) flags.push("NAMED");',
        '  if (flags.length > 0) {',
        '    html.push("<div class=\\"flags-row\\">");',
        '    for (var fi = 0; fi < flags.length; fi++) html.push("<span class=\\"flag\\">" + flags[fi] + "</span>");',
        '    html.push("</div>");',
        '  }',
        '',
        '  var creatures = getCreaturesForRegion(r);',
        '  if (creatures.length > 0) {',
        '    html.push("<table><thead><tr><th>Creature</th><th>Lvl</th><th></th></tr></thead><tbody>");',
        '    for (var ci = 0; ci < creatures.length; ci++) {',
        '      var c = creatures[ci];',
        '      var nameHtml = c.sourceFile',
        '        ? "<span class=\\"link\\" data-file=\\"" + escapeHtml(c.sourceFile) + "\\">" + escapeHtml(c.displayName) + "</span>"',
        '        : escapeHtml(c.displayName);',
        '      var badges = "";',
        '      if (c.isBoss) badges += "<span class=\\"boss-badge\\">BOSS</span>";',
        '      if (c.tameable) badges += " <span style=\\"color:#22c55e;font-size:10px\\">[T]</span>";',
        '      html.push("<tr><td>" + nameHtml + "</td><td>" + c.level + "</td><td>" + badges + "</td></tr>");',
        '    }',
        '    html.push("</tbody></table>");',
        '  } else {',
        '    html.push("<div class=\\"empty-msg\\">No creatures</div>");',
        '  }',
        '',
        '  if (r.sourceFile) {',
        '    html.push("<div style=\\"margin-top:8px\\"><span class=\\"link\\" data-file=\\"" + escapeHtml(r.sourceFile) + "\\">Open region file</span></div>");',
        '  }',
        '  document.getElementById("regionContent").innerHTML = html.join("");',
        '',
        '  // Wire up overlap navigation buttons',
        '  var prevBtn = document.getElementById("overlapPrev");',
        '  var nextBtn = document.getElementById("overlapNext");',
        '  if (prevBtn) prevBtn.addEventListener("click", function() { cycleRegion(-1); });',
        '  if (nextBtn) nextBtn.addEventListener("click", function() { cycleRegion(1); });',
        '',
        '  setTimeout(function() { resizeCanvas(); render(); }, 20);',
        '}',
        '',
        'function getCreaturesForRegion(r) {',
        '  var result = [];',
        '  var seen = {};',
        '  if (!planetData) return result;',
        '  for (var gi = 0; gi < r.spawnGroups.length; gi++) {',
        '    var group = planetData.spawnGroups[r.spawnGroups[gi]];',
        '    if (!group) continue;',
        '    for (var li = 0; li < group.lairSpawns.length; li++) {',
        '      var lair = planetData.lairTemplates[group.lairSpawns[li].lairTemplateName];',
        '      if (!lair) continue;',
        '      for (var mi = 0; mi < lair.mobiles.length; mi++) {',
        '        var name = lair.mobiles[mi].name;',
        '        if (seen[name]) continue; seen[name] = true;',
        '        var def = planetData.creatures[name];',
        '        result.push({ name: name, displayName: name.replace(/_/g, " "), level: def ? def.level : 0,',
        '          isBoss: false, tameable: def && def.tamingChance > 0, sourceFile: def ? def.sourceFile : null });',
        '      }',
        '      for (var bi = 0; bi < lair.bossMobiles.length; bi++) {',
        '        var name = lair.bossMobiles[bi].name;',
        '        if (seen[name]) continue; seen[name] = true;',
        '        var def = planetData.creatures[name];',
        '        result.push({ name: name, displayName: name.replace(/_/g, " "), level: def ? def.level : 0,',
        '          isBoss: true, tameable: def && def.tamingChance > 0, sourceFile: def ? def.sourceFile : null });',
        '      }',
        '    }',
        '  }',
        '  result.sort(function(a, b) { return a.name < b.name ? -1 : a.name > b.name ? 1 : 0; });',
        '  return result;',
        '}',
        '',
        'function describeShape(r) {',
        '  var s = r.shape;',
        '  if (s.type === "circle") return "Circle r=" + s.radius + " at (" + r.x + ", " + r.y + ")";',
        '  if (s.type === "rectangle") return "Rect (" + r.x + "," + r.y + ") to (" + s.x2 + "," + s.y2 + ")";',
        '  if (s.type === "ring") return "Ring r=" + s.innerRadius + "-" + s.outerRadius + " at (" + r.x + "," + r.y + ")";',
        '  return "?";',
        '}',
        '',
        'function escapeHtml(str) {',
        '  if (!str) return "";',
        '  return str.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");',
        '}',
        '',
        'function buildReports() {',
        '  if (!planetData) return;',
        '  var html = [];',
        '',
        '  // 0-region creatures (defined but not in any spawn group lair)',
        '  var unspawned = allCreatures.filter(function(c) { return c.regionCount === 0; });',
        '  html.push("<div class=\\"report-section\\">",',
        '    "<h3>Unspawned Creatures <span class=\\"report-count\\">(" + unspawned.length + ")</span></h3>");',
        '  if (unspawned.length > 0) {',
        '    html.push("<table class=\\"report-table\\"><thead><tr><th>Creature</th><th>Level</th><th>Type</th></tr></thead><tbody>");',
        '    for (var i = 0; i < unspawned.length; i++) {',
        '      var c = unspawned[i];',
        '      var typeLabel = c.mobType === 3 ? "NPC" : c.tamingChance > 0 ? "Tameable" : "Creature";',
        '      var nameLink = c.sourceFile',
        '        ? "<span class=\\"link\\" data-file=\\"" + escapeHtml(c.sourceFile) + "\\">" + escapeHtml(c.name.replace(/_/g, " ")) + "</span>"',
        '        : escapeHtml(c.name.replace(/_/g, " "));',
        '      html.push("<tr><td>" + nameLink + "</td><td>L" + c.level + "</td><td>" + typeLabel + "</td></tr>");',
        '    }',
        '    html.push("</tbody></table>");',
        '  } else {',
        '    html.push("<div class=\\"empty-msg\\">All creatures are spawned in at least one region</div>");',
        '  }',
        '  html.push("</div>");',
        '',
        '  // Missing lairs / warnings from server data',
        '  if (planetData.warnings && planetData.warnings.length > 0) {',
        '    var grouped = {};',
        '    for (var w = 0; w < planetData.warnings.length; w++) {',
        '      var warn = planetData.warnings[w];',
        '      if (!grouped[warn.type]) grouped[warn.type] = [];',
        '      grouped[warn.type].push(warn);',
        '    }',
        '    var typeLabels = { "missing-lair": "Missing Lairs", "missing-creature": "Missing Creatures",',
        '      "empty-group": "Empty Spawn Groups", "zero-weight": "Zero-Weight Entries", "cross-planet": "Cross-Planet References" };',
        '    var types = Object.keys(grouped);',
        '    for (var ti = 0; ti < types.length; ti++) {',
        '      var type = types[ti];',
        '      var items = grouped[type];',
        '      html.push("<div class=\\"report-section\\">",',
        '        "<h3>" + (typeLabels[type] || type) + " <span class=\\"report-count\\">(" + items.length + ")</span></h3>");',
        '      html.push("<table class=\\"report-table\\"><thead><tr><th>Issue</th><th>Details</th></tr></thead><tbody>");',
        '      for (var ii = 0; ii < items.length; ii++) {',
        '        var item = items[ii];',
        '        var msgHtml = item.sourceFile',
        '          ? "<span class=\\"link\\" data-file=\\"" + escapeHtml(item.sourceFile) + "\\">" + escapeHtml(item.message) + "</span>"',
        '          : escapeHtml(item.message);',
        '        html.push("<tr><td>" + msgHtml + "</td><td>" + escapeHtml(item.details || "") + "</td></tr>");',
        '      }',
        '      html.push("</tbody></table></div>");',
        '    }',
        '  }',
        '',
        '  document.getElementById("reportsContent").innerHTML = html.join("");',
        '  // Add click-to-open-file support',
        '  document.getElementById("reportsContent").addEventListener("click", function(e) {',
        '    var el = e.target;',
        '    while (el && el !== this) {',
        '      if (el.dataset && el.dataset.file) {',
        '        vscode.postMessage({ type: "openFile", path: el.dataset.file });',
        '        return;',
        '      }',
        '      el = el.parentElement;',
        '    }',
        '  });',
        '}',
        '',
        '// ══════════════════════════════════════════════════════════════',
        '// ══ STATIC SPAWNS TAB ══════════════════════════════════════════',
        '// ══════════════════════════════════════════════════════════════',
        '',
        'var sCanvas, sCtx;',
        'var sViewX = 0, sViewZ = 0, sZoom = 0.035;',
        'var sIsDragging = false, sDragStartX = 0, sDragStartY = 0, sDragViewX = 0, sDragViewZ = 0;',
        'var selectedScreenplay = null;',  // index into planetData.staticSpawns
        'var sfWorld = true, sfInterior = true, sfCategory = "";',
        'var sSearchText = "";',
        '',
        '// Category colors',
        'var catColors = { cave: "#a855f7", poi: "#3b82f6", city: "#22c55e", static: "#eab308", dungeon: "#ef4444", custom: "#ec4899" };',
        '',
        'function initStaticCanvas() {',
        '  sCanvas = document.getElementById("staticCanvas");',
        '  if (!sCanvas) return;',
        '  sCtx = sCanvas.getContext("2d");',
        '  setupStaticCanvasEvents();',
        '  setupStaticControls();',
        '}',
        '',
        'function resizeStaticCanvas() {',
        '  if (!sCanvas) return;',
        '  var container = sCanvas.parentElement;',
        '  var w = container.clientWidth;',
        '  var h = container.clientHeight;',
        '  if (w > 0 && h > 0) { sCanvas.width = w; sCanvas.height = h; }',
        '}',
        '',
        'function setupStaticCanvasEvents() {',
        '  sCanvas.addEventListener("mousedown", function(e) {',
        '    if (e.button === 0) {',
        '      sIsDragging = true;',
        '      sDragStartX = e.clientX; sDragStartY = e.clientY;',
        '      sDragViewX = sViewX; sDragViewZ = sViewZ;',
        '      sCanvas.style.cursor = "grabbing";',
        '    }',
        '  });',
        '  window.addEventListener("mousemove", function(e) {',
        '    if (sIsDragging) {',
        '      sViewX = sDragViewX - (e.clientX - sDragStartX) / sZoom;',
        '      sViewZ = sDragViewZ + (e.clientY - sDragStartY) / sZoom;',
        '      renderStatic();',
        '    }',
        '    if (sCanvas && document.getElementById("tabStatic").classList.contains("active")) {',
        '      var rect = sCanvas.getBoundingClientRect();',
        '      var w = sWorldFromScreen(e.clientX - rect.left, e.clientY - rect.top);',
        '      document.getElementById("staticCoordsOverlay").textContent = Math.round(w.x) + ", " + Math.round(w.z);',
        '    }',
        '  });',
        '  window.addEventListener("mouseup", function() {',
        '    if (sIsDragging) { sIsDragging = false; if (sCanvas) sCanvas.style.cursor = "crosshair"; }',
        '  });',
        '',
        '  // Zoom with scroll wheel',
        '  sCanvas.addEventListener("wheel", function(e) {',
        '    e.preventDefault();',
        '    var rect = sCanvas.getBoundingClientRect();',
        '    var mx = e.clientX - rect.left, my = e.clientY - rect.top;',
        '    var wBefore = sWorldFromScreen(mx, my);',
        '    var factor = e.deltaY < 0 ? 1.15 : 1 / 1.15;',
        '    var sMinZoom = Math.min(sCanvas.width, sCanvas.height) / 16000 * 0.9;',
        '    sZoom = Math.max(sMinZoom, Math.min(2, sZoom * factor));',
        '    var wAfter = sWorldFromScreen(mx, my);',
        '    sViewX -= (wAfter.x - wBefore.x);',
        '    sViewZ -= (wAfter.z - wBefore.z);',
        '    renderStatic();',
        '  });',
        '',
        '  // Click to select cluster/spawn',
        '  sCanvas.addEventListener("click", function(e) {',
        '    if (!planetData || !planetData.staticSpawns) return;',
        '    var rect = sCanvas.getBoundingClientRect();',
        '    var w = sWorldFromScreen(e.clientX - rect.left, e.clientY - rect.top);',
        '    handleStaticClick(w.x, w.z, e.clientX - rect.left, e.clientY - rect.top);',
        '  });',
        '  sCanvas.style.cursor = "crosshair";',
        '}',
        '',
        'function sScreenFromWorld(wx, wz) {',
        '  return { x: sCanvas.width / 2 + (wx - sViewX) * sZoom, y: sCanvas.height / 2 - (wz - sViewZ) * sZoom };',
        '}',
        'function sWorldFromScreen(sx, sy) {',
        '  return { x: sViewX + (sx - sCanvas.width / 2) / sZoom, z: sViewZ - (sy - sCanvas.height / 2) / sZoom };',
        '}',
        'function sFitToView() {',
        '  sViewX = 0; sViewZ = 0;',
        '  sZoom = Math.min(sCanvas.width, sCanvas.height) / 16000 * 0.9;',
        '}',
        '',
        'function setupStaticControls() {',
        '  document.getElementById("staticSearch").addEventListener("input", function() {',
        '    sSearchText = this.value.toLowerCase();',
        '    populateStaticList();',
        '    renderStatic();',
        '  });',
        '  document.getElementById("sfWorld").addEventListener("change", function(e) {',
        '    sfWorld = e.target.checked; populateStaticList(); renderStatic();',
        '  });',
        '  document.getElementById("sfInterior").addEventListener("change", function(e) {',
        '    sfInterior = e.target.checked; populateStaticList(); renderStatic();',
        '  });',
        '  document.getElementById("sfCategory").addEventListener("change", function(e) {',
        '    sfCategory = e.target.value; populateStaticList(); renderStatic();',
        '  });',
        '  document.getElementById("staticDetailClose").addEventListener("click", function() {',
        '    document.getElementById("staticDetailPanel").classList.remove("open");',
        '    selectedScreenplay = null;',
        '    resizeStaticCanvas(); renderStatic();',
        '  });',
        '  document.getElementById("staticDetailContent").addEventListener("click", function(e) {',
        '    var el = e.target;',
        '    while (el && el !== this) {',
        '      if (el.dataset && el.dataset.file) {',
        '        vscode.postMessage({ type: "openFile", path: el.dataset.file, line: parseInt(el.dataset.line) || 0 });',
        '        return;',
        '      }',
        '      el = el.parentElement;',
        '    }',
        '  });',
        '}',
        '',
        '// ── Populate screenplay list ──',
        'function populateStaticList() {',
        '  var list = document.getElementById("staticList");',
        '  if (!planetData || !planetData.staticSpawns || planetData.staticSpawns.length === 0) {',
        '    list.innerHTML = "<div class=\\"empty-msg\\">No static spawns found</div>";',
        '    document.getElementById("staticCount").textContent = "";',
        '    return;',
        '  }',
        '  var html = [];',
        '  var count = 0;',
        '  var totalSpawns = 0;',
        '  var lastCat = "";',
        '  var catLabels = { cave: "Caves", poi: "Points of Interest", city: "Cities", static: "Static Spawns", dungeon: "Dungeons", custom: "Custom" };',
        '',
        '  for (var i = 0; i < planetData.staticSpawns.length; i++) {',
        '    var sp = planetData.staticSpawns[i];',
        '    // Apply filters',
        '    if (sfCategory && sp.category !== sfCategory) continue;',
        '    if (!sfWorld && sp.worldSpawnCount > 0 && sp.interiorSpawnCount === 0) continue;',
        '    if (!sfInterior && sp.interiorSpawnCount > 0 && sp.worldSpawnCount === 0) continue;',
        '    if (sSearchText) {',
        '      var matchName = sp.name.toLowerCase().indexOf(sSearchText) !== -1;',
        '      var matchMob = false;',
        '      for (var si = 0; si < sp.spawns.length; si++) {',
        '        if (sp.spawns[si].template.indexOf(sSearchText) !== -1) { matchMob = true; break; }',
        '      }',
        '      if (!matchName && !matchMob) continue;',
        '    }',
        '',
        '    // Category header',
        '    if (sp.category !== lastCat) {',
        '      lastCat = sp.category;',
        '      html.push("<div class=\\"sp-group-header\\">" + (catLabels[sp.category] || sp.category) + "</div>");',
        '    }',
        '',
        '    var sel = (selectedScreenplay === i) ? " selected" : "";',
        '    var catClass = "sp-cat-" + sp.category;',
        '    html.push("<div class=\\"sp-item" + sel + "\\" data-idx=\\"" + i + "\\">",',
        '      "<span class=\\"sp-name\\">" + escapeHtml(sp.name) + "</span>",',
        '      "<span class=\\"sp-count\\">" + sp.spawns.length + "</span>",',
        '    "</div>");',
        '    count++;',
        '    totalSpawns += sp.spawns.length;',
        '  }',
        '  document.getElementById("staticCount").textContent = count + " screenplays, " + totalSpawns + " spawns";',
        '  if (count === 0) {',
        '    list.innerHTML = "<div class=\\"empty-msg\\">No matches</div>";',
        '  } else {',
        '    list.innerHTML = html.join("");',
        '  }',
        '  list.querySelectorAll(".sp-item").forEach(function(el) {',
        '    el.addEventListener("click", function() {',
        '      var idx = parseInt(el.dataset.idx);',
        '      selectScreenplay(idx === selectedScreenplay ? null : idx);',
        '    });',
        '  });',
        '}',
        '',
        'function selectScreenplay(idx) {',
        '  selectedScreenplay = idx;',
        '  document.querySelectorAll(".sp-item").forEach(function(el) {',
        '    el.classList.toggle("selected", parseInt(el.dataset.idx) === idx);',
        '  });',
        '  if (idx !== null && planetData && planetData.staticSpawns[idx]) {',
        '    showStaticDetail(planetData.staticSpawns[idx], idx);',
        '  } else {',
        '    document.getElementById("staticDetailPanel").classList.remove("open");',
        '  }',
        '  resizeStaticCanvas();',
        '  renderStatic();',
        '}',
        '',
        '// ── Static map rendering ──',
        'function renderStatic() {',
        '  if (!sCtx || !sCanvas) return;',
        '  sCtx.fillStyle = "#1a1a2e";',
        '  sCtx.fillRect(0, 0, sCanvas.width, sCanvas.height);',
        '  drawStaticGrid();',
        '  drawStaticBoundary();',
        '  if (planetData && planetData.staticSpawns) drawStaticSpawns();',
        '}',
        '',
        'function drawStaticGrid() {',
        '  var gridSize = 1000;',
        '  var tl = sWorldFromScreen(0, 0);',
        '  var br = sWorldFromScreen(sCanvas.width, sCanvas.height);',
        '  var minX = Math.floor(Math.min(tl.x, br.x) / gridSize) * gridSize;',
        '  var maxX = Math.ceil(Math.max(tl.x, br.x) / gridSize) * gridSize;',
        '  var minZ = Math.floor(Math.min(tl.z, br.z) / gridSize) * gridSize;',
        '  var maxZ = Math.ceil(Math.max(tl.z, br.z) / gridSize) * gridSize;',
        '  sCtx.strokeStyle = "rgba(255,255,255,0.06)"; sCtx.lineWidth = 1;',
        '  for (var x = minX; x <= maxX; x += gridSize) {',
        '    var s = sScreenFromWorld(x, 0);',
        '    sCtx.beginPath(); sCtx.moveTo(s.x, 0); sCtx.lineTo(s.x, sCanvas.height); sCtx.stroke();',
        '  }',
        '  for (var z = minZ; z <= maxZ; z += gridSize) {',
        '    var s = sScreenFromWorld(0, z);',
        '    sCtx.beginPath(); sCtx.moveTo(0, s.y); sCtx.lineTo(sCanvas.width, s.y); sCtx.stroke();',
        '  }',
        '  sCtx.strokeStyle = "rgba(255,255,255,0.15)";',
        '  var ox = sScreenFromWorld(0, 0);',
        '  sCtx.beginPath(); sCtx.moveTo(ox.x, 0); sCtx.lineTo(ox.x, sCanvas.height); sCtx.stroke();',
        '  sCtx.beginPath(); sCtx.moveTo(0, ox.y); sCtx.lineTo(sCanvas.width, ox.y); sCtx.stroke();',
        '}',
        '',
        'function drawStaticBoundary() {',
        '  var tl = sScreenFromWorld(-8000, 8000);',
        '  var br = sScreenFromWorld(8000, -8000);',
        '  sCtx.strokeStyle = "rgba(255,255,255,0.2)"; sCtx.lineWidth = 2;',
        '  sCtx.strokeRect(tl.x, tl.y, br.x - tl.x, br.y - tl.y);',
        '}',
        '',
        'function drawStaticSpawns() {',
        '  if (!planetData || !planetData.staticSpawns) return;',
        '  var spawns = planetData.staticSpawns;',
        '',
        '  // Collect all visible dots',
        '  var dots = [];',
        '  for (var i = 0; i < spawns.length; i++) {',
        '    var sp = spawns[i];',
        '    if (sfCategory && sp.category !== sfCategory) continue;',
        '    var color = catColors[sp.category] || "#888";',
        '    var isSelected = (selectedScreenplay === i);',
        '    for (var j = 0; j < sp.spawns.length; j++) {',
        '      var s = sp.spawns[j];',
        '      if (s.cellId !== 0 && !sfInterior) continue;',
        '      if (s.cellId === 0 && !sfWorld) continue;',
        '      if (sSearchText) {',
        '        var matchName = sp.name.toLowerCase().indexOf(sSearchText) !== -1;',
        '        var matchMob = s.template.indexOf(sSearchText) !== -1;',
        '        if (!matchName && !matchMob) continue;',
        '      }',
        '      var pos = resolveSpawnPos(s);',
        '      dots.push({ x: pos.x, y: pos.y, color: color, selected: isSelected, spIdx: i, template: s.template, cellId: s.cellId });',
        '    }',
        '  }',
        '',
        '  // Cluster dots that are too close at current zoom',
        '  var clusterRadius = 12; // pixels',
        '  var clusters = clusterDots(dots, clusterRadius);',
        '',
        '  // Draw non-selected first, then selected on top',
        '  for (var pass = 0; pass < 2; pass++) {',
        '    for (var ci = 0; ci < clusters.length; ci++) {',
        '      var c = clusters[ci];',
        '      var anySelected = false;',
        '      for (var di = 0; di < c.dots.length; di++) {',
        '        if (c.dots[di].selected) { anySelected = true; break; }',
        '      }',
        '      if (pass === 0 && anySelected) continue;',
        '      if (pass === 1 && !anySelected) continue;',
        '',
        '      var scr = sScreenFromWorld(c.cx, c.cy);',
        '      var baseColor = c.dots[0].color;',
        '',
        '      if (c.dots.length === 1) {',
        '        // Single dot',
        '        var dot = c.dots[0];',
        '        var r = anySelected ? 6 : (selectedScreenplay !== null ? 2 : 4);',
        '        var alpha = anySelected ? 1.0 : (selectedScreenplay !== null ? 0.15 : 0.7);',
        '        sCtx.fillStyle = hexToRgba(baseColor, alpha);',
        '        sCtx.beginPath(); sCtx.arc(scr.x, scr.y, r, 0, Math.PI * 2); sCtx.fill();',
        '        if (anySelected) {',
        '          sCtx.strokeStyle = "#fff"; sCtx.lineWidth = 1.5;',
        '          sCtx.beginPath(); sCtx.arc(scr.x, scr.y, r, 0, Math.PI * 2); sCtx.stroke();',
        '        }',
        '        // Interior marker (small diamond)',
        '        if (dot.cellId !== 0) {',
        '          sCtx.fillStyle = "rgba(255,255,255," + (alpha * 0.8) + ")";',
        '          sCtx.beginPath(); sCtx.moveTo(scr.x, scr.y - r - 2); sCtx.lineTo(scr.x + 2, scr.y - r);',
        '          sCtx.lineTo(scr.x, scr.y - r + 2); sCtx.lineTo(scr.x - 2, scr.y - r); sCtx.fill();',
        '        }',
        '      } else {',
        '        // Cluster',
        '        var clusterR = Math.min(20, 8 + Math.log2(c.dots.length) * 3);',
        '        var alpha = anySelected ? 0.9 : (selectedScreenplay !== null ? 0.1 : 0.5);',
        '        sCtx.fillStyle = hexToRgba(baseColor, alpha);',
        '        sCtx.beginPath(); sCtx.arc(scr.x, scr.y, clusterR, 0, Math.PI * 2); sCtx.fill();',
        '        sCtx.strokeStyle = hexToRgba(baseColor, alpha + 0.2);',
        '        sCtx.lineWidth = anySelected ? 2 : 1;',
        '        sCtx.beginPath(); sCtx.arc(scr.x, scr.y, clusterR, 0, Math.PI * 2); sCtx.stroke();',
        '        // Count label',
        '        sCtx.font = "bold 10px sans-serif"; sCtx.textAlign = "center"; sCtx.textBaseline = "middle";',
        '        sCtx.fillStyle = "rgba(255,255,255," + (anySelected ? 1.0 : 0.8) + ")";',
        '        sCtx.fillText(c.dots.length.toString(), scr.x, scr.y);',
        '      }',
        '    }',
        '  }',
        '',
        '  // Draw labels for selected screenplay dots when zoomed in',
        '  if (selectedScreenplay !== null && sZoom > 0.15) {',
        '    sCtx.font = "10px sans-serif"; sCtx.textAlign = "left"; sCtx.textBaseline = "middle";',
        '    for (var ci = 0; ci < clusters.length; ci++) {',
        '      var c = clusters[ci];',
        '      if (c.dots.length !== 1 || !c.dots[0].selected) continue;',
        '      var scr = sScreenFromWorld(c.cx, c.cy);',
        '      var label = c.dots[0].template.replace(/_/g, " ");',
        '      sCtx.fillStyle = "rgba(0,0,0,0.7)";',
        '      var tw = sCtx.measureText(label).width;',
        '      sCtx.fillRect(scr.x + 8, scr.y - 7, tw + 6, 14);',
        '      sCtx.fillStyle = "#fff";',
        '      sCtx.fillText(label, scr.x + 11, scr.y);',
        '    }',
        '  }',
        '}',
        '',
        '// Resolve spawn position: interior spawns use building world position from .ws snapshot',
        'function resolveSpawnPos(s) {',
        '  if (s.cellId !== 0 && cellPositionMap[String(s.cellId)]) {',
        '    var bld = cellPositionMap[String(s.cellId)];',
        '    return { x: bld.x, y: bld.y };',
        '  }',
        '  return { x: s.x, y: s.y };',
        '}',
        '',
        '// Simple grid-based clustering',
        'function clusterDots(dots, radiusPx) {',
        '  var cellSize = radiusPx * 2;',
        '  var grid = {};',
        '  for (var i = 0; i < dots.length; i++) {',
        '    var d = dots[i];',
        '    var scr = sScreenFromWorld(d.x, d.y);',
        '    var gx = Math.floor(scr.x / cellSize);',
        '    var gy = Math.floor(scr.y / cellSize);',
        '    var key = gx + "," + gy;',
        '    if (!grid[key]) grid[key] = { dots: [], sx: 0, sy: 0 };',
        '    grid[key].dots.push(d);',
        '    grid[key].sx += d.x;',
        '    grid[key].sy += d.y;',
        '  }',
        '  var clusters = [];',
        '  var keys = Object.keys(grid);',
        '  for (var k = 0; k < keys.length; k++) {',
        '    var cell = grid[keys[k]];',
        '    var n = cell.dots.length;',
        '    clusters.push({ cx: cell.sx / n, cy: cell.sy / n, dots: cell.dots });',
        '  }',
        '  return clusters;',
        '}',
        '',
        '// ── Static click handling ──',
        'function handleStaticClick(wx, wz, sx, sy) {',
        '  if (!planetData || !planetData.staticSpawns) return;',
        '',
        '  // Build visible dots and clusters (same as render)',
        '  var dots = [];',
        '  var spawns = planetData.staticSpawns;',
        '  for (var i = 0; i < spawns.length; i++) {',
        '    var sp = spawns[i];',
        '    if (sfCategory && sp.category !== sfCategory) continue;',
        '    for (var j = 0; j < sp.spawns.length; j++) {',
        '      var s = sp.spawns[j];',
        '      if (s.cellId !== 0 && !sfInterior) continue;',
        '      if (s.cellId === 0 && !sfWorld) continue;',
        '      var pos = resolveSpawnPos(s);',
        '      dots.push({ x: pos.x, y: pos.y, spIdx: i, template: s.template, cellId: s.cellId, line: s.line });',
        '    }',
        '  }',
        '  var clusters = clusterDots(dots, 12);',
        '',
        '  // Find closest cluster to click',
        '  var bestDist = Infinity, bestCluster = null;',
        '  for (var ci = 0; ci < clusters.length; ci++) {',
        '    var c = clusters[ci];',
        '    var scr = sScreenFromWorld(c.cx, c.cy);',
        '    var dx = scr.x - sx, dy = scr.y - sy;',
        '    var dist = Math.sqrt(dx * dx + dy * dy);',
        '    var hitRadius = c.dots.length === 1 ? 10 : Math.min(25, 12 + Math.log2(c.dots.length) * 3);',
        '    if (dist < hitRadius && dist < bestDist) {',
        '      bestDist = dist;',
        '      bestCluster = c;',
        '    }',
        '  }',
        '',
        '  if (bestCluster) {',
        '    if (bestCluster.dots.length > 1 && sZoom < 0.5) {',
        '      // Zoom into cluster',
        '      sViewX = bestCluster.cx;',
        '      sViewZ = bestCluster.cy;',
        '      sZoom = Math.min(2, sZoom * 3);',
        '      renderStatic();',
        '    } else {',
        '      // Select the screenplay of the first dot',
        '      var spIdx = bestCluster.dots[0].spIdx;',
        '      selectScreenplay(spIdx === selectedScreenplay ? null : spIdx);',
        '    }',
        '  } else {',
        '    // Click on empty space — deselect',
        '    if (selectedScreenplay !== null) selectScreenplay(null);',
        '  }',
        '}',
        '',
        '// ── Static detail panel ──',
        'function showStaticDetail(sp, idx) {',
        '  var panel = document.getElementById("staticDetailPanel");',
        '  panel.classList.add("open");',
        '  document.getElementById("staticDetailTitle").textContent = sp.name;',
        '',
        '  var html = [];',
        '  var catLabels = { cave: "Cave", poi: "Point of Interest", city: "City", static: "Static", dungeon: "Dungeon", custom: "Custom" };',
        '  html.push("<div class=\\"meta\\">");',
        '  html.push("<div><b>Category:</b> <span class=\\"sp-cat-badge sp-cat-" + sp.category + "\\">" + (catLabels[sp.category] || sp.category) + "</span></div>");',
        '  html.push("<div><b>Spawns:</b> " + sp.spawns.length + " (" + sp.worldSpawnCount + " world, " + sp.interiorSpawnCount + " interior)</div>");',
        '  html.push("<div><span class=\\"link\\" data-file=\\"" + escapeHtml(sp.sourceFile) + "\\">Open source file</span></div>");',
        '  html.push("</div>");',
        '',
        '  // Group spawns by template (alphabetical)',
        '  var grouped = {};',
        '  for (var i = 0; i < sp.spawns.length; i++) {',
        '    var s = sp.spawns[i];',
        '    if (!grouped[s.template]) grouped[s.template] = { count: 0, worldCount: 0, intCount: 0, line: s.line };',
        '    grouped[s.template].count++;',
        '    if (s.cellId === 0) grouped[s.template].worldCount++;',
        '    else grouped[s.template].intCount++;',
        '  }',
        '  var templates = Object.keys(grouped).sort();',
        '',
        '  html.push("<table><thead><tr><th>Mobile</th><th>#</th><th>Loc</th></tr></thead><tbody>");',
        '  for (var ti = 0; ti < templates.length; ti++) {',
        '    var t = templates[ti];',
        '    var g = grouped[t];',
        '    var nameHtml = "<span class=\\"link\\" data-file=\\"" + escapeHtml(sp.sourceFile) + "\\" data-line=\\"" + g.line + "\\">" + escapeHtml(t.replace(/_/g, " ")) + "</span>";',
        '    var locTag = g.intCount > 0 ? "<span style=\\"opacity:0.5\\">int</span>" : "<span style=\\"opacity:0.5\\">wld</span>";',
        '    if (g.worldCount > 0 && g.intCount > 0) locTag = "<span style=\\"opacity:0.5\\">both</span>";',
        '    html.push("<tr><td>" + nameHtml + "</td><td>" + g.count + "</td><td>" + locTag + "</td></tr>");',
        '  }',
        '  html.push("</tbody></table>");',
        '',
        '  document.getElementById("staticDetailContent").innerHTML = html.join("");',
        '  setTimeout(function() { resizeStaticCanvas(); renderStatic(); }, 20);',
        '}',
        '',
        'function timeSince(ts) {',
        '  var s = Math.floor((Date.now() - ts) / 1000);',
        '  if (s < 60) return "just now";',
        '  var m = Math.floor(s / 60);',
        '  if (m < 60) return m + "m ago";',
        '  var h = Math.floor(m / 60);',
        '  if (h < 24) return h + "h ago";',
        '  var d = Math.floor(h / 24);',
        '  return d + "d ago";',
        '}',
        '',
        '// ══════════════════════════════════════════════════════════════',
        '// ══ WORLD SPAWNS TAB ══════════════════════════════════════════',
        '// ══════════════════════════════════════════════════════════════',
        '',
        'var wCanvas, wCtx;',
        'var wViewX = 0, wViewZ = 0, wZoom = 0.035;',
        'var wIsDragging = false, wDragStartX = 0, wDragStartY = 0, wDragViewX = 0, wDragViewZ = 0;',
        'var worldEntries = [];',    // built from planet data
        'var worldExclusions = [];', // regions blocking world spawns
        'var worldGroupName = "";',
        'var worldMaxSpawns = 0;',
        'var wfBabies = false, wfNpcs = false;',
        'var wClMin = 1, wClMax = 300;',
        'var wSearchText = "";',
        '',
        'function initWorldCanvas() {',
        '  wCanvas = document.getElementById("worldCanvas");',
        '  if (!wCanvas) return;',
        '  wCtx = wCanvas.getContext("2d");',
        '  setupWorldCanvasEvents();',
        '  setupWorldControls();',
        '}',
        '',
        'function resizeWorldCanvas() {',
        '  if (!wCanvas) return;',
        '  var container = wCanvas.parentElement;',
        '  var w = container.clientWidth;',
        '  var h = container.clientHeight;',
        '  if (w > 0 && h > 0) { wCanvas.width = w; wCanvas.height = h; }',
        '}',
        '',
        'function setupWorldCanvasEvents() {',
        '  wCanvas.addEventListener("mousedown", function(e) {',
        '    if (e.button === 0) {',
        '      wIsDragging = true;',
        '      wDragStartX = e.clientX; wDragStartY = e.clientY;',
        '      wDragViewX = wViewX; wDragViewZ = wViewZ;',
        '      wCanvas.style.cursor = "grabbing";',
        '    }',
        '  });',
        '  window.addEventListener("mousemove", function(e) {',
        '    if (wIsDragging) {',
        '      wViewX = wDragViewX - (e.clientX - wDragStartX) / wZoom;',
        '      wViewZ = wDragViewZ + (e.clientY - wDragStartY) / wZoom;',
        '      renderWorldMap();',
        '    }',
        '    if (wCanvas && document.getElementById("tabWorld") && document.getElementById("tabWorld").classList.contains("active")) {',
        '      var rect = wCanvas.getBoundingClientRect();',
        '      var ww = wWorldFromScreen(e.clientX - rect.left, e.clientY - rect.top);',
        '      document.getElementById("worldCoordsOverlay").textContent = Math.round(ww.x) + ", " + Math.round(ww.z);',
        '    }',
        '  });',
        '  window.addEventListener("mouseup", function() {',
        '    if (wIsDragging) { wIsDragging = false; if (wCanvas) wCanvas.style.cursor = "default"; }',
        '  });',
        '  wCanvas.addEventListener("wheel", function(e) {',
        '    e.preventDefault();',
        '    var rect = wCanvas.getBoundingClientRect();',
        '    var mx = e.clientX - rect.left;',
        '    var my = e.clientY - rect.top;',
        '    var before = wWorldFromScreen(mx, my);',
        '    var factor = e.deltaY < 0 ? 1.15 : 0.87;',
        '    var wMinZoom = Math.min(wCanvas.width, wCanvas.height) / 16000 * 0.9;',
        '    wZoom = Math.max(wMinZoom, Math.min(0.5, wZoom * factor));',
        '    var after = wWorldFromScreen(mx, my);',
        '    wViewX -= (after.x - before.x);',
        '    wViewZ -= (after.z - before.z);',
        '    renderWorldMap();',
        '  });',
        '}',
        '',
        'function wWorldFromScreen(sx, sy) {',
        '  return { x: (sx - wCanvas.width / 2) / wZoom + wViewX, z: -(sy - wCanvas.height / 2) / wZoom + wViewZ };',
        '}',
        'function wScreenFromWorld(wx, wz) {',
        '  return { x: (wx - wViewX) * wZoom + wCanvas.width / 2, y: -(wz - wViewZ) * wZoom + wCanvas.height / 2 };',
        '}',
        '',
        'function setupWorldControls() {',
        '  document.getElementById("worldSearch").addEventListener("input", function(e) {',
        '    wSearchText = e.target.value.toLowerCase(); renderWorldList();',
        '  });',
        '  document.getElementById("wfBabies").addEventListener("change", function(e) {',
        '    wfBabies = e.target.checked; renderWorldList();',
        '  });',
        '  document.getElementById("wfNpcs").addEventListener("change", function(e) {',
        '    wfNpcs = e.target.checked; renderWorldList();',
        '  });',
        '  document.getElementById("wClMin").addEventListener("input", function(e) {',
        '    wClMin = parseInt(e.target.value); document.getElementById("wClMinLabel").textContent = wClMin; renderWorldList();',
        '  });',
        '  document.getElementById("wClMax").addEventListener("input", function(e) {',
        '    wClMax = parseInt(e.target.value); document.getElementById("wClMaxLabel").textContent = wClMax; renderWorldList();',
        '  });',
        '}',
        '',
        'function buildWorldData() {',
        '  worldEntries = [];',
        '  worldExclusions = [];',
        '  worldGroupName = "";',
        '  worldMaxSpawns = 0;',
        '  if (!planetData) return;',
        '',
        '  // Find world spawn regions and exclusion zones',
        '  var regions = planetData.regions || [];',
        '  for (var i = 0; i < regions.length; i++) {',
        '    var r = regions[i];',
        '    if (r.isWorldSpawn && r.spawnGroups && r.spawnGroups.length > 0) {',
        '      worldGroupName = r.spawnGroups[0];',
        '      worldMaxSpawns = r.maxSpawnLimit || 0;',
        '    }',
        '    if (r.isNoSpawnArea || r.isNoWorldSpawn || r.isCity) {',
        '      worldExclusions.push(r);',
        '    }',
        '  }',
        '',
        '  // Look up the world spawn group',
        '  var group = planetData.spawnGroups[worldGroupName];',
        '  if (!group) { return; }',
        '',
        '  // Compute total weighting',
        '  var totalWeight = 0;',
        '  for (var j = 0; j < group.lairSpawns.length; j++) {',
        '    totalWeight += group.lairSpawns[j].weighting;',
        '  }',
        '',
        '  // Build entries with creature info',
        '  for (var k = 0; k < group.lairSpawns.length; k++) {',
        '    var ls = group.lairSpawns[k];',
        '    var lair = planetData.lairTemplates[ls.lairTemplateName];',
        '    var creatures = [];',
        '    var bosses = [];',
        '    var maxLevel = 0;',
        '    var hasBaby = false;',
        '    var hasNpc = false;',
        '    if (lair) {',
        '      for (var m = 0; m < lair.mobiles.length; m++) {',
        '        var c = planetData.creatures[lair.mobiles[m].name];',
        '        var lvl = c ? c.level : 0;',
        '        if (lvl > maxLevel) maxLevel = lvl;',
        '        if (c && c.tamingChance > 0) hasBaby = true;',
        '        if (c && c.mobType === 3) hasNpc = true;',
        '        creatures.push({ name: lair.mobiles[m].name, level: lvl, weight: lair.mobiles[m].weight });',
        '      }',
        '      for (var b = 0; b < lair.bossMobiles.length; b++) {',
        '        var bc = planetData.creatures[lair.bossMobiles[b].name];',
        '        bosses.push({ name: lair.bossMobiles[b].name, level: bc ? bc.level : 0 });',
        '      }',
        '    }',
        '    worldEntries.push({',
        '      lairName: ls.lairTemplateName,',
        '      creatures: creatures,',
        '      bosses: bosses,',
        '      weighting: ls.weighting,',
        '      spawnChance: totalWeight > 0 ? (ls.weighting / totalWeight * 100) : 0,',
        '      spawnLimit: ls.spawnLimit,',
        '      minDifficulty: ls.minDifficulty,',
        '      maxDifficulty: ls.maxDifficulty,',
        '      size: ls.size,',
        '      maxLevel: maxLevel,',
        '      hasBaby: hasBaby,',
        '      hasNpc: hasNpc,',
        '    });',
        '  }',
        '',
        '  // Sort alphabetically by primary creature name',
        '  worldEntries.sort(function(a, b) {',
        '    var na = a.creatures.length > 0 ? a.creatures[0].name : a.lairName;',
        '    var nb = b.creatures.length > 0 ? b.creatures[0].name : b.lairName;',
        '    return na.localeCompare(nb);',
        '  });',
        '}',
        '',
        'function renderWorldMap() {',
        '  if (!wCanvas || !wCtx) return;',
        '  var w = wCanvas.width, h = wCanvas.height;',
        '  wCtx.clearRect(0, 0, w, h);',
        '',
        '  // Draw grid',
        '  wCtx.strokeStyle = "rgba(255,255,255,0.05)";',
        '  wCtx.lineWidth = 1;',
        '  var gridStep = 1000;',
        '  for (var gx = -8000; gx <= 8000; gx += gridStep) {',
        '    var s1 = wScreenFromWorld(gx, -8192);',
        '    var s2 = wScreenFromWorld(gx, 8192);',
        '    wCtx.beginPath(); wCtx.moveTo(s1.x, s1.y); wCtx.lineTo(s2.x, s2.y); wCtx.stroke();',
        '  }',
        '  for (var gz = -8000; gz <= 8000; gz += gridStep) {',
        '    var s3 = wScreenFromWorld(-8192, gz);',
        '    var s4 = wScreenFromWorld(8192, gz);',
        '    wCtx.beginPath(); wCtx.moveTo(s3.x, s3.y); wCtx.lineTo(s4.x, s4.y); wCtx.stroke();',
        '  }',
        '',
        '  // Draw planet boundary',
        '  var tl = wScreenFromWorld(-8192, 8192);',
        '  var br = wScreenFromWorld(8192, -8192);',
        '  wCtx.strokeStyle = "rgba(255,255,255,0.15)";',
        '  wCtx.lineWidth = 1;',
        '  wCtx.strokeRect(tl.x, tl.y, br.x - tl.x, br.y - tl.y);',
        '',
        '  // Draw exclusion zones',
        '  for (var i = 0; i < worldExclusions.length; i++) {',
        '    var r = worldExclusions[i];',
        '    var isNoWorld = r.isNoWorldSpawn && !r.isNoSpawnArea;',
        '    var isCity = r.isCity && !r.isNoSpawnArea && !r.isNoWorldSpawn;',
        '',
        '    if (r.isNoSpawnArea) {',
        '      wCtx.fillStyle = "rgba(239,68,68,0.25)";',
        '      wCtx.strokeStyle = "rgba(239,68,68,0.5)";',
        '    } else if (isNoWorld) {',
        '      wCtx.fillStyle = "rgba(249,115,22,0.2)";',
        '      wCtx.strokeStyle = "rgba(249,115,22,0.4)";',
        '    } else if (isCity) {',
        '      wCtx.fillStyle = "rgba(59,130,246,0.1)";',
        '      wCtx.strokeStyle = "rgba(59,130,246,0.4)";',
        '    } else {',
        '      wCtx.fillStyle = "rgba(249,115,22,0.15)";',
        '      wCtx.strokeStyle = "rgba(249,115,22,0.3)";',
        '    }',
        '    wCtx.lineWidth = 1;',
        '',
        '    if (r.shape.type === "circle") {',
        '      var center = wScreenFromWorld(r.x, r.y);',
        '      var edge = wScreenFromWorld(r.x + r.shape.radius, r.y);',
        '      var rad = edge.x - center.x;',
        '      wCtx.beginPath();',
        '      wCtx.arc(center.x, center.y, Math.abs(rad), 0, Math.PI * 2);',
        '      wCtx.fill(); wCtx.stroke();',
        '    } else if (r.shape.type === "rectangle") {',
        '      var x1 = r.x, z1 = r.y, x2 = r.shape.x2, z2 = r.shape.y2;',
        '      if (x1 === 0 && z1 === 0 && x2 === 0 && z2 === 0) continue;',
        '      var rtl = wScreenFromWorld(Math.min(x1,x2), Math.max(z1,z2));',
        '      var rbr = wScreenFromWorld(Math.max(x1,x2), Math.min(z1,z2));',
        '      wCtx.fillRect(rtl.x, rtl.y, rbr.x - rtl.x, rbr.y - rtl.y);',
        '      wCtx.strokeRect(rtl.x, rtl.y, rbr.x - rtl.x, rbr.y - rtl.y);',
        '    } else if (r.shape.type === "ring") {',
        '      var rc = wScreenFromWorld(r.x, r.y);',
        '      var rOuter = wScreenFromWorld(r.x + r.shape.outerRadius, r.y);',
        '      var rInner = wScreenFromWorld(r.x + r.shape.innerRadius, r.y);',
        '      var outerR = Math.abs(rOuter.x - rc.x);',
        '      var innerR = Math.abs(rInner.x - rc.x);',
        '      wCtx.beginPath();',
        '      wCtx.arc(rc.x, rc.y, outerR, 0, Math.PI * 2);',
        '      wCtx.arc(rc.x, rc.y, innerR, 0, Math.PI * 2, true);',
        '      wCtx.fill(); wCtx.stroke();',
        '    }',
        '',
        '    // Label large enough zones',
        '    if (r.shape.type === "circle" && r.shape.radius * wZoom > 15) {',
        '      var lc = wScreenFromWorld(r.x, r.y);',
        '      wCtx.fillStyle = "rgba(255,255,255,0.5)";',
        '      wCtx.font = "9px sans-serif";',
        '      wCtx.textAlign = "center";',
        '      var label = r.name.replace(/@[^:]+:/, "").replace(/_/g, " ");',
        '      wCtx.fillText(label, lc.x, lc.y + 3);',
        '    }',
        '  }',
        '',
        '  // Legend',
        '  wCtx.fillStyle = "rgba(255,255,255,0.4)";',
        '  wCtx.font = "10px sans-serif";',
        '  wCtx.textAlign = "left";',
        '  wCtx.fillText("World spawns fill open areas (no overlay)", 8, h - 8);',
        '}',
        '',
        'function renderWorldList() {',
        '  var list = document.getElementById("worldList");',
        '  var countEl = document.getElementById("worldCount");',
        '  var footer = document.getElementById("worldFooter");',
        '  if (!list) return;',
        '',
        '  if (worldEntries.length === 0) {',
        '    list.innerHTML = "<div class=\\"empty-msg\\">No world spawn data</div>";',
        '    if (countEl) countEl.textContent = "";',
        '    if (footer) footer.textContent = "";',
        '    return;',
        '  }',
        '',
        '  // Apply filters',
        '  var filtered = [];',
        '  for (var i = 0; i < worldEntries.length; i++) {',
        '    var e = worldEntries[i];',
        '    if (wfBabies && !e.hasBaby) continue;',
        '    if (wfNpcs && !e.hasNpc) continue;',
        '    // CL filter: any creature in the entry must be within range',
        '    var clMatch = false;',
        '    for (var j = 0; j < e.creatures.length; j++) {',
        '      if (e.creatures[j].level >= wClMin && e.creatures[j].level <= wClMax) { clMatch = true; break; }',
        '    }',
        '    if (!clMatch && e.creatures.length > 0) continue;',
        '    // Search',
        '    if (wSearchText) {',
        '      var found = false;',
        '      if (e.lairName.toLowerCase().indexOf(wSearchText) >= 0) found = true;',
        '      for (var s = 0; s < e.creatures.length; s++) {',
        '        if (e.creatures[s].name.toLowerCase().indexOf(wSearchText) >= 0) { found = true; break; }',
        '      }',
        '      if (!found) continue;',
        '    }',
        '    filtered.push(e);',
        '  }',
        '',
        '  if (countEl) countEl.textContent = filtered.length + " of " + worldEntries.length + " entries";',
        '',
        '  // Find max spawn chance for bar scaling',
        '  var maxPct = 0;',
        '  for (var p = 0; p < filtered.length; p++) {',
        '    if (filtered[p].spawnChance > maxPct) maxPct = filtered[p].spawnChance;',
        '  }',
        '',
        '  var html = [];',
        '  // Legend',
        '  html.push("<div class=\\"world-legend\\">");',
        '  html.push("  <span><span class=\\"wl-dot wl-nospawn\\"></span> No Spawn</span>");',
        '  html.push("  <span><span class=\\"wl-dot wl-noworld\\"></span> No World Spawn</span>");',
        '  html.push("  <span><span class=\\"wl-dot wl-city\\"></span> City</span>");',
        '  html.push("</div>");',
        '',
        '  for (var n = 0; n < filtered.length; n++) {',
        '    var entry = filtered[n];',
        '    // Primary creature name (first mobile in lair)',
        '    var primaryName = entry.creatures.length > 0 ? entry.creatures[0].name : entry.lairName;',
        '    var primaryLevel = entry.creatures.length > 0 ? entry.creatures[0].level : 0;',
        '    var pctStr = entry.spawnChance < 1 ? entry.spawnChance.toFixed(2) : entry.spawnChance.toFixed(1);',
        '    var barWidth = maxPct > 0 ? (entry.spawnChance / maxPct * 100) : 0;',
        '',
        '    html.push("<div class=\\"world-entry\\">");',
        '    html.push("  <div class=\\"we-header\\">");',
        '    html.push("    <span class=\\"we-name\\">" + primaryName.replace(/_/g, " ") + "</span>");',
        '    html.push("    <span class=\\"we-pct\\">" + pctStr + "%</span>");',
        '    html.push("  </div>");',
        '',
        '    // Details line',
        '    var details = [];',
        '    details.push("CL " + primaryLevel);',
        '    details.push("wt:" + entry.weighting);',
        '    if (entry.spawnLimit > 0 && entry.spawnLimit < 100) details.push("lim:" + entry.spawnLimit);',
        '    if (entry.creatures.length > 1) details.push(entry.creatures.length + " mobs");',
        '    if (entry.bosses.length > 0) details.push(entry.bosses.length + " boss");',
        '    if (entry.minDifficulty > 5) details.push("diff:" + entry.minDifficulty + "-" + entry.maxDifficulty);',
        '    html.push("  <div class=\\"we-details\\">" + details.join(" | ") + "</div>");',
        '',
        '    // % bar',
        '    html.push("  <div class=\\"we-bar\\"><div class=\\"we-bar-fill\\" style=\\"width:" + barWidth + "%\\"></div></div>");',
        '',
        '    // Extra creatures if > 1',
        '    if (entry.creatures.length > 1) {',
        '      html.push("  <div class=\\"we-details\\">");',
        '      for (var ci = 1; ci < entry.creatures.length; ci++) {',
        '        html.push(entry.creatures[ci].name.replace(/_/g, " ") + " (CL" + entry.creatures[ci].level + ")");',
        '        if (ci < entry.creatures.length - 1) html.push(", ");',
        '      }',
        '      html.push("  </div>");',
        '    }',
        '    if (entry.bosses.length > 0) {',
        '      html.push("  <div class=\\"we-details\\"><span style=\\"color:#f97316\\">Boss: ");',
        '      for (var bi = 0; bi < entry.bosses.length; bi++) {',
        '        html.push(entry.bosses[bi].name.replace(/_/g, " ") + " (CL" + entry.bosses[bi].level + ")");',
        '        if (bi < entry.bosses.length - 1) html.push(", ");',
        '      }',
        '      html.push("</span></div>");',
        '    }',
        '',
        '    html.push("</div>");',
        '  }',
        '',
        '  list.innerHTML = html.join("");',
        '',
        '  // Footer',
        '  if (footer) {',
        '    footer.textContent = "World: " + worldGroupName + " | " + worldEntries.length + " lair entries | max spawns: " + worldMaxSpawns;',
        '  }',
        '}',
        '',
        'function updateWorldTab() {',
        '  buildWorldData();',
        '  renderWorldList();',
        '  resizeWorldCanvas();',
        '  renderWorldMap();',
        '}',
    ].join('\n');
}
